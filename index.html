<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Financial Command Center</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --bg-primary: #0a0a0a;
            --bg-secondary: #1a1a1a;
            --bg-tertiary: #2a2a2a;
            --text-primary: #ffffff;
            --text-secondary: #e0e0e0;
            --text-muted: #9ca3af;
            --accent-positive: #4ade80;
            --accent-negative: #f87171;
            --accent-warning: #fbbf24;
            --accent-info: #60a5fa;
            --accent-primary: #3b82f6;
            --border: #2a2a2a;
            --border-hover: #3a3a3a;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-primary);
            color: var(--text-secondary);
            line-height: 1.6;
            overflow-x: hidden;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        /* Tabs */
        .tabs {
            display: flex;
            gap: 12px;
            margin-bottom: 30px;
            border-bottom: 1px solid var(--border);
            padding-bottom: 12px;
        }
        
        .tab {
            padding: 8px 20px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px 8px 0 0;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }
        
        .tab.active {
            background: var(--accent-primary);
            color: white;
            border-color: var(--accent-primary);
        }
        
        .tab:hover:not(.active) {
            background: var(--bg-tertiary);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* Enhanced Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 20px;
        }
        
        h1 {
            font-size: clamp(1.5rem, 4vw, 2.5rem);
            font-weight: 300;
            color: var(--text-primary);
        }
        
        .header-stats {
            display: flex;
            gap: 24px;
            flex-wrap: wrap;
        }
        
        .stat-pill {
            background: var(--bg-secondary);
            padding: 16px 24px;
            border-radius: 12px;
            border: 2px solid var(--border);
            font-size: 1rem;
            min-width: 140px;
            text-align: center;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .stat-pill .help-icon {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 16px;
            height: 16px;
            font-size: 11px;
        }
        
        .stat-pill-label {
            font-size: 0.85rem;
            color: var(--text-muted);
            margin-bottom: 4px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .stat-pill-value {
            font-size: 1.4rem;
            font-weight: 700;
            line-height: 1.2;
        }
        
        .stat-pill.status-good {
            border-color: var(--accent-positive);
            background: rgba(74, 222, 128, 0.1);
        }
        
        .stat-pill.status-good .stat-pill-value {
            color: var(--accent-positive);
        }
        
        .stat-pill.status-warning {
            border-color: var(--accent-warning);
            background: rgba(251, 191, 36, 0.1);
        }
        
        .stat-pill.status-warning .stat-pill-value {
            color: var(--accent-warning);
        }
        
        .stat-pill.status-bad {
            border-color: var(--accent-negative);
            background: rgba(248, 113, 113, 0.1);
        }
        
        .stat-pill.status-bad .stat-pill-value {
            color: var(--accent-negative);
        }
        
        /* Help Tooltips */
        .help-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 18px;
            height: 18px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 50%;
            font-size: 12px;
            cursor: help;
            position: relative;
            margin-left: 8px;
            transition: all 0.2s ease;
        }
        
        .help-icon:hover {
            background: var(--accent-primary);
            color: white;
            border-color: var(--accent-primary);
        }
        
        .tooltip {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 12px;
            width: 250px;
            font-size: 0.85rem;
            line-height: 1.4;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s ease;
            z-index: 10000;
            margin-bottom: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        
        /* Adjust tooltip position if it would be cut off */
        .header .help-icon .tooltip {
            bottom: auto;
            top: 100%;
            margin-bottom: 0;
            margin-top: 8px;
        }
        
        .help-icon:hover .tooltip {
            opacity: 1;
        }
        
        /* Quick Actions */
        .quick-actions {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 30px;
        }
        
        .income-form {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
            margin-bottom: 20px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        label {
            font-size: 0.9rem;
            color: var(--text-muted);
        }
        
        input, select {
            background: var(--bg-primary);
            border: 1px solid var(--border-hover);
            color: var(--text-secondary);
            padding: 10px 16px;
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.2s ease;
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        button {
            background: var(--accent-primary);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.2s ease;
            font-weight: 500;
        }
        
        button:hover {
            background: #2563eb;
            transform: translateY(-1px);
        }
        
        button.secondary {
            background: var(--bg-tertiary);
            color: var(--text-secondary);
        }
        
        button.secondary:hover {
            background: #3a3a3a;
        }
        
        button.danger {
            background: var(--accent-negative);
        }
        
        button.danger:hover {
            background: #dc2626;
        }
        
        button.edit-btn {
            background: var(--accent-warning);
            color: var(--bg-primary);
            padding: 4px 12px;
            font-size: 0.85rem;
            border-radius: 4px;
            margin-right: 8px;
        }
        
        button.edit-btn:hover {
            background: #f59e0b;
        }
        
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 12px;
        }
        
        input[type="checkbox"] {
            width: auto;
        }
        
        /* Income Ledger */
        .income-ledger {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
            overflow-x: auto;
        }
        
        .ledger-table {
            width: 100%;
            min-width: 1000px;
        }
        
        .ledger-table th {
            background: var(--bg-primary);
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .delete-btn {
            background: transparent;
            border: 1px solid var(--accent-negative);
            color: var(--accent-negative);
            padding: 4px 12px;
            font-size: 0.85rem;
            border-radius: 4px;
        }
        
        .delete-btn:hover {
            background: var(--accent-negative);
            color: white;
        }
        
        /* Dashboard Grid */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 24px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 2px;
            background: linear-gradient(90deg, transparent, var(--accent-primary), transparent);
            transform: translateX(-100%);
            transition: transform 0.6s ease;
        }
        
        .card:hover::before {
            transform: translateX(100%);
        }
        
        .card:hover {
            border-color: var(--border-hover);
            transform: translateY(-2px);
        }
        
        .card h2 {
            font-size: 1.1rem;
            margin-bottom: 16px;
            color: var(--text-primary);
            font-weight: 400;
            display: flex;
            align-items: center;
        }
        
        .card-value {
            font-size: 2rem;
            font-weight: 600;
            margin-bottom: 8px;
        }
        
        .positive { color: var(--accent-positive); }
        .negative { color: var(--accent-negative); }
        .warning { color: var(--accent-warning); }
        .info { color: var(--accent-info); }
        
        .subtitle {
            font-size: 0.9rem;
            color: var(--text-muted);
        }
        
        .edit-icon {
            margin-left: 8px;
            cursor: pointer;
            font-size: 0.8rem;
            opacity: 0.5;
            transition: opacity 0.2s ease;
        }
        
        .edit-icon:hover {
            opacity: 1;
        }
        
        /* Progress Bars */
        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--bg-tertiary);
            border-radius: 4px;
            overflow: hidden;
            margin-top: 12px;
        }
        
        .progress-fill {
            height: 100%;
            background: var(--accent-positive);
            transition: width 0.3s ease;
        }
        
        .progress-fill.warning {
            background: var(--accent-warning);
        }
        
        .progress-fill.danger {
            background: var(--accent-negative);
        }
        
        /* Sections */
        .section {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
        }
        
        .section h2 {
            font-size: 1.3rem;
            margin-bottom: 20px;
            color: var(--text-primary);
            font-weight: 400;
            display: flex;
            align-items: center;
        }
        
        /* Tables */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }
        
        th {
            font-weight: 500;
            color: var(--text-muted);
            font-size: 0.9rem;
            text-transform: uppercase;
        }
        
        tr:hover {
            background: rgba(255, 255, 255, 0.02);
        }
        
        /* Charts */
        .chart-container {
            position: relative;
            height: 300px;
            margin-top: 20px;
        }
        
        /* Income Summary */
        .income-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px;
            margin-top: 20px;
        }
        
        .income-type-card {
            background: var(--bg-primary);
            padding: 16px;
            border-radius: 8px;
            border: 1px solid var(--border);
            text-align: center;
        }
        
        .income-type-label {
            font-size: 0.85rem;
            color: var(--text-muted);
            margin-bottom: 4px;
        }
        
        .income-type-amount {
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--accent-positive);
        }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(4px);
        }
        
        .modal-content {
            background: var(--bg-secondary);
            margin: 5% auto;
            padding: 30px;
            border: 1px solid var(--border);
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .close {
            color: var(--text-muted);
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.2s ease;
        }
        
        .close:hover {
            color: var(--text-primary);
        }
        
        /* Split Editor */
        .split-editor {
            background: var(--bg-primary);
            padding: 16px;
            border-radius: 8px;
            margin-top: 16px;
        }
        
        .split-inputs {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 12px;
        }
        
        .split-input-group {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        
        .split-input-group input {
            padding: 8px 12px;
        }
        
        /* Manual Payment Section */
        .payment-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .payment-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
        }
        
        .payment-card h3 {
            color: var(--text-primary);
            margin-bottom: 16px;
            display: flex;
            align-items: center;
        }
        
        /* What-if Calculator */
        .what-if-section {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
        }
        
        .what-if-inputs {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 16px;
        }
        
        .what-if-result {
            background: var(--bg-primary);
            padding: 16px;
            border-radius: 8px;
            margin-top: 16px;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 12px;
            }
            
            .header {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .header-stats {
                width: 100%;
                justify-content: space-between;
            }
            
            .stat-pill {
                min-width: 120px;
                padding: 12px 16px;
            }
            
            .stat-pill-value {
                font-size: 1.2rem;
            }
            
            .tabs {
                flex-wrap: wrap;
                overflow-x: auto;
                scrollbar-width: thin;
            }
            
            .tabs::-webkit-scrollbar {
                height: 6px;
            }
            
            .tabs::-webkit-scrollbar-thumb {
                background: var(--border-hover);
                border-radius: 3px;
            }
            
            .tab {
                font-size: 0.9rem;
                padding: 6px 16px;
            }
            
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            .income-form {
                grid-template-columns: 1fr;
            }
            
            .modal-content {
                margin: 10% auto;
                padding: 20px;
            }
            
            .ledger-table {
                font-size: 0.85rem;
            }
        }
        
        /* Animations */
        .pulse {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.4);
            }
            70% {
                box-shadow: 0 0 0 10px rgba(59, 130, 246, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(59, 130, 246, 0);
            }
        }
        
        .milestone-reached {
            animation: celebrate 0.5s ease;
        }
        
        @keyframes celebrate {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.1);
            }
        }
        
        /* Interest Bleed */
        .bleed-rate {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 12px;
            margin-top: 20px;
        }
        
        .bleed-item {
            background: rgba(248, 113, 113, 0.1);
            border: 1px solid rgba(248, 113, 113, 0.3);
            padding: 12px;
            border-radius: 8px;
            text-align: center;
        }
        
        .bleed-label {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-bottom: 4px;
        }
        
        .bleed-value {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--accent-negative);
        }
        
        /* Quarterly Tax Cards */
        .quarter-card {
            background: var(--bg-secondary);
            border: 2px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            position: relative;
        }
        
        .quarter-card.current {
            border-color: var(--accent-primary);
        }
        
        .quarter-card.overdue {
            border-color: var(--accent-negative);
            background: rgba(248, 113, 113, 0.05);
        }
        
        .quarter-card h3 {
            margin-bottom: 12px;
            color: var(--text-primary);
        }
        
        .quarter-status {
            position: absolute;
            top: 12px;
            right: 12px;
            padding: 4px 12px;
            border-radius: 16px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .quarter-status.paid {
            background: rgba(74, 222, 128, 0.2);
            color: var(--accent-positive);
        }
        
        .quarter-status.due {
            background: rgba(251, 191, 36, 0.2);
            color: var(--accent-warning);
        }
        
        .quarter-status.overdue {
            background: rgba(248, 113, 113, 0.2);
            color: var(--accent-negative);
        }
        
        .quarter-details {
            display: grid;
            gap: 8px;
            margin-bottom: 16px;
        }
        
        .quarter-detail {
            display: flex;
            justify-content: space-between;
            font-size: 0.9rem;
        }
        
        .quarter-detail-label {
            color: var(--text-muted);
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div>
                <h1>Financial Command Center</h1>
                <div style="font-size: 0.75rem; color: var(--text-muted); margin-top: 4px;">
                    v2025.06.17.1 • Last saved: <span id="lastSaved">Never</span>
                </div>
            </div>
            <div class="header-stats">
                <div class="stat-pill" id="totalDebtPill">
                    <div class="stat-pill-label">Total Debt</div>
                    <div class="stat-pill-value" id="totalDebtHeader">$0</div>
                    <span class="help-icon">ⓘ
                        <span class="tooltip">Green = Below $50k (Great!)<br>Yellow = $50k-$75k (Caution)<br>Red = Above $75k (Focus needed)</span>
                    </span>
                </div>
                <div class="stat-pill" id="monthlyInterestPill">
                    <div class="stat-pill-label">Monthly Interest</div>
                    <div class="stat-pill-value" id="monthlyInterestHeader">$0</div>
                    <span class="help-icon">ⓘ
                        <span class="tooltip">Green = Below $500/mo<br>Yellow = $500-$800/mo<br>Red = Above $800/mo</span>
                    </span>
                </div>
                <div class="stat-pill" id="payoffDatePill">
                    <div class="stat-pill-label">Debt Free Date</div>
                    <div class="stat-pill-value" id="payoffDateHeader">--</div>
                    <span class="help-icon">ⓘ
                        <span class="tooltip">Based on average payment history and current strategy</span>
                    </span>
                </div>
            </div>
        </div>
        
        <!-- Tabs -->
        <div class="tabs">
            <div class="tab active" onclick="switchTab('overview', event)">Overview</div>
            <div class="tab" onclick="switchTab('income', event)">Income</div>
            <div class="tab" onclick="switchTab('debts', event)">Debts</div>
            <div class="tab" onclick="switchTab('taxes', event)">Quarterly Taxes</div>
            <div class="tab" onclick="switchTab('payments', event)">Manual Payments</div>
            <div class="tab" onclick="switchTab('settings', event)">Settings</div>
        </div>
        
        <!-- Overview Tab -->
        <div class="tab-content active" id="overview-tab">
            <!-- Quick Actions -->
            <div class="quick-actions">
                <h2>Record Income</h2>
                <form onsubmit="recordIncome(event)" class="income-form">
                    <div class="form-group">
                        <label>Amount</label>
                        <input type="number" id="overrideIncome" placeholder="Enter amount" step="0.01" required>
                    </div>
                    <div class="form-group">
                        <label>Income Type</label>
                        <select id="incomeType">
                            <option value="salary">Salary (W-2)</option>
                            <option value="override">Override (1099)</option>
                            <option value="commission">Commission (1099)</option>
                            <option value="distribution">Distribution (K-1)</option>
                            <option value="bonus">Bonus (W-2)</option>
                            <option value="other-w2">Other (W-2)</option>
                            <option value="other-1099">Other (1099)</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Notes</label>
                        <input type="text" id="incomeNotes" placeholder="Optional notes">
                    </div>
                    <div class="form-group" style="align-self: end;">
                        <button type="submit" class="pulse">Record Income</button>
                    </div>
                </form>
                
                <div class="checkbox-group">
                    <input type="checkbox" id="useDefaultSplit" checked>
                    <label for="useDefaultSplit">Use default split (10% tithe, 22.9% tax, rest to debt)
                        <span class="help-icon">ⓘ
                            <span class="tooltip">When checked, income will be split using your default percentages set in Settings. Uncheck to customize this specific income entry. Note: Tax reserve only applies to 1099 income (Commission and Override).</span>
                        </span>
                    </label>
                </div>
                
                <!-- Custom Split Editor -->
                <div class="split-editor" id="customSplitEditor" style="display: none;">
                    <h3>Custom Split for This Income</h3>
                    <div class="split-inputs">
                        <div class="split-input-group">
                            <label>Tithe %</label>
                            <input type="number" id="customTithe" value="10" min="0" max="100" step="0.1">
                        </div>
                        <div class="split-input-group">
                            <label>Tax %</label>
                            <input type="number" id="customTax" value="22.9" min="0" max="100" step="0.1">
                        </div>
                        <div class="split-input-group">
                            <label>Debt %</label>
                            <input type="number" id="customDebt" value="30" min="0" max="100" step="0.1">
                        </div>
                        <div class="split-input-group">
                            <label>Flexible %</label>
                            <input type="number" id="customFlexible" value="37.1" readonly style="background: var(--bg-tertiary);">
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Main Dashboard -->
            <div class="dashboard-grid">
                <!-- Quarterly Tax Status -->
                <div class="card">
                    <h2>
                        2025 Tax Status
                        <span class="help-icon">ⓘ
                            <span class="tooltip">Tracks your quarterly estimated tax payments for 1099 income only. Commission and Override income contribute to this goal. W-2 income (Salary, Bonus) and K-1 distributions do not affect this since taxes are handled differently for those income types.</span>
                        </span>
                    </h2>
                    <div class="card-value" id="taxStatus">$0</div>
                    <div class="subtitle">
                        <span id="taxContributed">$0</span> of <span id="taxGoal">$9,566</span> goal
                        <span class="edit-icon" onclick="editTaxGoal()">✎</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="taxProgress" style="width: 0%"></div>
                    </div>
                </div>
                
                <!-- Current Quarter Tax -->
                <div class="card">
                    <h2>
                        Current Quarter Tax
                        <span class="help-icon">ⓘ
                            <span class="tooltip">Shows unpaid estimated tax for the current quarter from 1099 income. This is NOT included in your total debt as it's not yet due.</span>
                        </span>
                    </h2>
                    <div class="card-value" id="currentQuarterTax">$0</div>
                    <div class="subtitle">
                        <span id="currentQuarter">Q1 2025</span> • Due <span id="currentQuarterDue">Apr 15</span>
                    </div>
                    <div id="currentQuarterStatus" style="margin-top: 12px; font-size: 0.9rem;">
                        <!-- Populated by JS -->
                    </div>
                </div>
                
                <!-- Total Income -->
                <div class="card">
                    <h2>
                        Total Income Tracked
                        <span class="help-icon">ⓘ
                            <span class="tooltip">Cumulative total of all income entries you've recorded in this dashboard. Click on Income tab to see detailed breakdown by type.</span>
                        </span>
                    </h2>
                    <div class="card-value positive" id="totalIncome">$0</div>
                    <div class="subtitle"><span id="incomeCount">0</span> entries recorded</div>
                </div>
                
                <!-- Debt Overview -->
                <div class="card">
                    <h2>
                        Total Debt
                        <span class="help-icon">ⓘ
                            <span class="tooltip">Sum of all debt balances with weighted average interest rate. Daily/weekly/monthly shows how much interest is accumulating.</span>
                        </span>
                    </h2>
                    <div class="card-value negative" id="totalDebt">$0</div>
                    <div class="subtitle">
                        <span id="debtCount">0</span> accounts • 
                        <span id="avgRate">0%</span> avg rate
                    </div>
                    <div class="bleed-rate" style="margin-top: 16px;">
                        <div class="bleed-item">
                            <div class="bleed-label">Daily</div>
                            <div class="bleed-value" id="dailyInterest">$0</div>
                        </div>
                        <div class="bleed-item">
                            <div class="bleed-label">Weekly</div>
                            <div class="bleed-value" id="weeklyInterest">$0</div>
                        </div>
                        <div class="bleed-item">
                            <div class="bleed-label">Monthly</div>
                            <div class="bleed-value" id="monthlyInterest">$0</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Income Type Breakdown -->
            <div class="section">
                <h2>Income by Type</h2>
                <div class="income-summary" id="incomeSummary">
                    <!-- Populated by JS -->
                </div>
            </div>
            
            <!-- What-If Calculator -->
            <div class="what-if-section">
                <h2>
                    What-If Debt Calculator
                    <span class="help-icon">ⓘ
                        <span class="tooltip">See how adding extra monthly payments would affect your debt payoff timeline. Enter different scenarios to plan your strategy.</span>
                    </span>
                </h2>
                <div class="what-if-inputs">
                    <div class="form-group">
                        <label>Extra Monthly Payment</label>
                        <input type="number" id="extraPayment" placeholder="$250" step="50" onchange="calculateWhatIf()">
                    </div>
                    <div class="form-group">
                        <label>Target Debt (Optional)</label>
                        <select id="targetDebt" onchange="calculateWhatIf()">
                            <option value="">All Debts (Current Strategy)</option>
                        </select>
                    </div>
                </div>
                <div class="what-if-result" id="whatIfResult" style="display: none;">
                    <!-- Results populated by JS -->
                </div>
            </div>
        </div>
        
        <!-- Income Tab -->
        <div class="tab-content" id="income-tab">
            <!-- Income Ledger -->
            <div class="income-ledger">
                <h2>
                    Income History
                    <span class="help-icon">ⓘ
                        <span class="tooltip">Complete history of all income entries. Use Edit to modify entries or Delete to remove them entirely. Changes will update all calculations automatically.</span>
                    </span>
                </h2>
                <div style="overflow-x: auto;">
                    <table class="ledger-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Gross Amount</th>
                                <th>Tithe</th>
                                <th>Tax Reserve</th>
                                <th>Debt</th>
                                <th>Flexible (Net)</th>
                                <th>Type</th>
                                <th>Notes</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="incomeLedger">
                            <!-- Populated by JS -->
                        </tbody>
                    </table>
                </div>
                <div style="margin-top: 20px; text-align: right;">
                    <button onclick="exportIncomeData()" class="secondary">Export to CSV</button>
                    <button onclick="confirmReset()" class="danger">Reset All Income History</button>
                </div>
            </div>
        </div>
        
        <!-- Debts Tab -->
        <div class="tab-content" id="debts-tab">
            <!-- Debt Strategy -->
            <div class="section">
                <h2>
                    Debt Strategy
                    <span class="help-icon">ⓘ
                        <span class="tooltip">Snowball method pays smallest balance first for psychological wins. Avalanche method pays highest interest rate first for maximum savings.</span>
                    </span>
                </h2>
                <div style="display: flex; gap: 12px; margin-bottom: 20px;">
                    <button onclick="setDebtStrategy('snowball')" id="snowballBtn">🏔️ Snowball (Smallest First)</button>
                    <button onclick="setDebtStrategy('avalanche')" id="avalancheBtn" class="secondary">⚡ Avalanche (Highest Rate)</button>
                </div>
            </div>
            
            <!-- Debt Details -->
            <div class="section">
                <h2>Debt Breakdown</h2>
                <table id="debtTable">
                    <thead>
                        <tr>
                            <th style="cursor: pointer;" onclick="sortDebts('name')">
                                Account <span id="sort-name" style="opacity: 0.5;">↕</span>
                            </th>
                            <th style="cursor: pointer;" onclick="sortDebts('balance')">
                                Balance <span id="sort-balance">↓</span>
                            </th>
                            <th style="cursor: pointer;" onclick="sortDebts('rate')">
                                Rate <span id="sort-rate" style="opacity: 0.5;">↕</span>
                            </th>
                            <th style="cursor: pointer;" onclick="sortDebts('minPayment')" title="Minimum monthly payment required">
                                Min Payment 
                                <span id="sort-minPayment" style="opacity: 0.5;">↕</span>
                                <span class="help-icon" style="position: static; margin-left: 4px;">ⓘ
                                    <span class="tooltip">Minimum monthly payment required by the creditor</span>
                                </span>
                            </th>
                            <th style="cursor: pointer;" onclick="sortDebts('monthlyInterest')">
                                Monthly Interest <span id="sort-monthlyInterest" style="opacity: 0.5;">↕</span>
                            </th>
                            <th>Payoff Date</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="debtTableBody">
                        <!-- Populated by JS -->
                    </tbody>
                </table>
                <div style="margin-top: 20px;">
                    <button onclick="showAddDebt()">Add New Debt</button>
                </div>
            </div>
            
            <!-- Payoff Timeline -->
            <div class="section">
                <h2>
                    Payoff Timeline
                    <span class="help-icon">ⓘ
                        <span class="tooltip">Projected debt balance over time based on your average income and payment history. This assumes you continue current patterns.</span>
                    </span>
                </h2>
                <div class="chart-container">
                    <canvas id="payoffChart"></canvas>
                </div>
            </div>
        </div>
        
        <!-- Quarterly Taxes Tab -->
        <div class="tab-content" id="taxes-tab">
            <div class="section">
                <h2>
                    2025 Quarterly Tax Overview
                    <span class="help-icon">ⓘ
                        <span class="tooltip">Tracks quarterly estimated tax payments for 1099 income. Only Commission, Override, and Other (1099) income contribute to these calculations.</span>
                    </span>
                </h2>
                <div id="quarterlyBreakdown" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-top: 20px;">
                    <!-- Populated by JS -->
                </div>
            </div>
            
            <div class="section">
                <h2>1099 Income Summary</h2>
                <table>
                    <thead>
                        <tr>
                            <th>Income Type</th>
                            <th>Total Received</th>
                            <th>Tax Reserved (22.9%)</th>
                            <th>Entry Count</th>
                        </tr>
                    </thead>
                    <tbody id="taxIncomeBreakdown">
                        <!-- Populated by JS -->
                    </tbody>
                </table>
            </div>
            
            <div class="section">
                <h2>Tax Payment History</h2>
                <table>
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Quarter</th>
                            <th>Amount</th>
                            <th>Notes</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="taxPaymentHistory">
                        <!-- Populated by JS -->
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Manual Payments Tab -->
        <div class="tab-content" id="payments-tab">
            <div class="payment-actions">
                <!-- Debt Payments -->
                <div class="payment-card">
                    <h3>
                        🏦 Record Debt Payment
                        <span class="help-icon">ⓘ
                            <span class="tooltip">Log manual payments made directly to debt accounts. This will update balances and progress tracking.</span>
                        </span>
                    </h3>
                    <form onsubmit="recordDebtPayment(event)">
                        <div class="form-group">
                            <label>Select Debt Account</label>
                            <select id="debtPaymentSelect" required>
                                <option value="">Choose debt account...</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Payment Amount</label>
                            <input type="number" id="debtPaymentAmount" step="0.01" required placeholder="0.00">
                        </div>
                        <div class="form-group">
                            <label>Payment Date</label>
                            <input type="date" id="debtPaymentDate" required>
                        </div>
                        <div class="form-group">
                            <label>Notes (Optional)</label>
                            <input type="text" id="debtPaymentNotes" placeholder="e.g., Extra payment, settlement">
                        </div>
                        <button type="submit">Record Debt Payment</button>
                    </form>
                </div>
                
                <!-- Tax Payments -->
                <div class="payment-card">
                    <h3>
                        📊 Record Tax Payment
                        <span class="help-icon">ⓘ
                            <span class="tooltip">Log quarterly estimated tax payments. This updates your tax status tracking and progress toward quarterly goals.</span>
                        </span>
                    </h3>
                    <form onsubmit="recordTaxPayment(event)">
                        <div class="form-group">
                            <label>Payment Amount</label>
                            <input type="number" id="taxPaymentAmount" step="0.01" required placeholder="0.00">
                        </div>
                        <div class="form-group">
                            <label>Payment Date</label>
                            <input type="date" id="taxPaymentDate" required>
                        </div>
                        <div class="form-group">
                            <label>Quarter</label>
                            <select id="taxPaymentQuarter" required>
                                <option value="Q1 2025">Q1 2025</option>
                                <option value="Q2 2025">Q2 2025</option>
                                <option value="Q3 2025">Q3 2025</option>
                                <option value="Q4 2025">Q4 2025</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Notes (Optional)</label>
                            <input type="text" id="taxPaymentNotes" placeholder="e.g., Estimated quarterly payment">
                        </div>
                        <button type="submit">Record Tax Payment</button>
                    </form>
                </div>
            </div>
            
            <!-- Payment History -->
            <div class="section">
                <h2>Payment History</h2>
                <div style="overflow-x: auto;">
                    <table>
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Type</th>
                                <th>Account/Category</th>
                                <th>Amount</th>
                                <th>Notes</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="paymentHistory">
                            <!-- Populated by JS -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- Settings Tab -->
        <div class="tab-content" id="settings-tab">
            <div class="section">
                <h2>
                    Default Income Split
                    <span class="help-icon">ⓘ
                        <span class="tooltip">Adjust the default percentages for how income is allocated. These can be overridden per income entry if needed.</span>
                    </span>
                </h2>
                <p style="color: var(--text-muted); margin-bottom: 20px;">
                    Adjust the default percentages for how income is allocated. These can be overridden per income entry.
                </p>
                <div class="split-inputs">
                    <div class="split-input-group">
                        <label>Tithe %</label>
                        <input type="number" id="defaultTithe" value="10" min="0" max="100" step="0.1" onchange="updateDefaultSplits()">
                    </div>
                    <div class="split-input-group">
                        <label>Tax Reserve %</label>
                        <input type="number" id="defaultTax" value="22.9" min="0" max="100" step="0.1" onchange="updateDefaultSplits()">
                    </div>
                    <div class="split-input-group">
                        <label>Debt %</label>
                        <input type="number" id="defaultDebt" value="30" min="0" max="100" step="0.1" onchange="updateDefaultSplits()">
                    </div>
                    <div class="split-input-group">
                        <label>Flexible %</label>
                        <input type="number" id="defaultFlexible" value="37.1" readonly style="background: var(--bg-tertiary);">
                    </div>
                </div>
            </div>
            
            <div class="section">
                <h2>
                    Metric Status Thresholds
                    <span class="help-icon">ⓘ
                        <span class="tooltip">Configure when the top metrics show green (good), yellow (warning), or red (behind) status colors.</span>
                    </span>
                </h2>
                <div class="split-inputs">
                    <div class="split-input-group">
                        <label>Debt Threshold (Good if below)</label>
                        <input type="number" id="debtThresholdGood" value="50000" step="1000" onchange="updateThresholds()">
                    </div>
                    <div class="split-input-group">
                        <label>Debt Threshold (Warning if below)</label>
                        <input type="number" id="debtThresholdWarning" value="75000" step="1000" onchange="updateThresholds()">
                    </div>
                    <div class="split-input-group">
                        <label>Interest Threshold (Warning if above)</label>
                        <input type="number" id="interestThresholdWarning" value="500" step="50" onchange="updateThresholds()">
                    </div>
                    <div class="split-input-group">
                        <label>Interest Threshold (Bad if above)</label>
                        <input type="number" id="interestThresholdBad" value="800" step="50" onchange="updateThresholds()">
                    </div>
                </div>
            </div>
            
            <div class="section">
                <h2>Data Management</h2>
                <button onclick="exportData()">Export All Data (JSON)</button>
                <button onclick="importData()" class="secondary">Import Data</button>
            </div>
        </div>
        
        <!-- Edit Income Modal -->
        <div id="editIncomeModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Edit Income Entry</h2>
                    <span class="close" onclick="closeModal('editIncomeModal')">&times;</span>
                </div>
                <form onsubmit="saveIncomeEdit(event)">
                    <div class="form-group">
                        <label>Amount</label>
                        <input type="number" id="editIncomeAmount" step="0.01" required>
                    </div>
                    <div class="form-group">
                        <label>Income Type</label>
                        <select id="editIncomeType">
                            <option value="salary">Salary (W-2)</option>
                            <option value="override">Override (1099)</option>
                            <option value="commission">Commission (1099)</option>
                            <option value="distribution">Distribution (K-1)</option>
                            <option value="bonus">Bonus (W-2)</option>
                            <option value="other-w2">Other (W-2)</option>
                            <option value="other-1099">Other (1099)</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Notes</label>
                        <input type="text" id="editIncomeNotes">
                    </div>
                    <div class="split-editor">
                        <h3>Allocation Split</h3>
                        <div class="split-inputs">
                            <div class="split-input-group">
                                <label>Tithe %</label>
                                <input type="number" id="editTithe" min="0" max="100" step="0.1">
                            </div>
                            <div class="split-input-group">
                                <label>Tax %</label>
                                <input type="number" id="editTax" min="0" max="100" step="0.1">
                            </div>
                            <div class="split-input-group">
                                <label>Debt %</label>
                                <input type="number" id="editDebt" min="0" max="100" step="0.1">
                            </div>
                            <div class="split-input-group">
                                <label>Flexible %</label>
                                <input type="number" id="editFlexible" readonly style="background: var(--bg-tertiary);">
                            </div>
                        </div>
                    </div>
                    <button type="submit">Save Changes</button>
                </form>
            </div>
        </div>
        
        <!-- Add Debt Modal -->
        <div id="addDebtModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Add New Debt</h2>
                    <span class="close" onclick="closeModal('addDebtModal')">&times;</span>
                </div>
                <form onsubmit="addDebt(event)">
                    <div class="form-group">
                        <label>Account Name</label>
                        <input type="text" id="debtName" required>
                    </div>
                    <div class="form-group">
                        <label>Current Balance</label>
                        <input type="number" id="debtBalance" step="0.01" required>
                    </div>
                    <div class="form-group">
                        <label>Interest Rate (%)</label>
                        <input type="number" id="debtRate" step="0.01" min="0" max="100" required>
                    </div>
                    <div class="form-group">
                        <label>Minimum Payment</label>
                        <input type="number" id="debtMinPayment" step="0.01" required>
                    </div>
                    <button type="submit">Add Debt</button>
                </form>
            </div>
        </div>
        
        <!-- Edit Tax Goal Modal -->
        <div id="editTaxModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Edit Quarterly Tax Goal</h2>
                    <span class="close" onclick="closeModal('editTaxModal')">&times;</span>
                </div>
                <form onsubmit="saveTaxGoal(event)">
                    <div class="form-group">
                        <label>Q1-Q2 2025 Tax Goal</label>
                        <input type="number" id="taxGoalInput" step="0.01" required>
                    </div>
                    <button type="submit">Save Goal</button>
                </form>
            </div>
        </div>
        
        <!-- Edit Payment Modal -->
        <div id="editPaymentModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Edit Payment</h2>
                    <span class="close" onclick="closeModal('editPaymentModal')">&times;</span>
                </div>
                <form onsubmit="savePaymentEdit(event)">
                    <div class="form-group">
                        <label>Payment Amount</label>
                        <input type="number" id="editPaymentAmount" step="0.01" required>
                    </div>
                    <div class="form-group">
                        <label>Payment Date</label>
                        <input type="date" id="editPaymentDate" required>
                    </div>
                    <div class="form-group" id="editPaymentAccountGroup">
                        <label id="editPaymentAccountLabel">Account</label>
                        <select id="editPaymentAccount">
                            <!-- Populated dynamically -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Notes (Optional)</label>
                        <input type="text" id="editPaymentNotes">
                    </div>
                    <button type="submit">Save Changes</button>
                </form>
            </div>
        </div>
    </div>
    
    <script>
        // State Management
        const state = {
            debts: [
                { id: 1, name: 'IRS 2022', balance: 10066, rate: 0.07, minPayment: 124.58, originalBalance: 10066 },
                { id: 2, name: 'IRS 2023', balance: 13153, rate: 0.07, minPayment: 124.58, originalBalance: 13153 },
                { id: 3, name: 'IRS 2024', balance: 33814, rate: 0.07, minPayment: 124.84, originalBalance: 33814 },
                { id: 4, name: 'Chase Card', balance: 17968, rate: 0.2924, minPayment: 538, originalBalance: 17968 },
                { id: 5, name: 'Pinnacle', balance: 22078, rate: 0, minPayment: 0, originalBalance: 22078 }
            ],
            quarterlyTaxGoal: 9566,
            quarterlyPaid: 0,
            strategy: 'snowball',
            defaultSplits: {
                tithe: 10,
                tax: 22.9,
                debt: 30,
                flexible: 37.1
            },
            thresholds: {
                debtGood: 50000,
                debtWarning: 75000,
                interestWarning: 500,
                interestBad: 800
            },
            incomeHistory: [],
            paymentHistory: [],
            totalInterestPaid: 0,
            currentEditingIncomeId: null,
            currentEditingPaymentId: null,
            debtSort: { column: 'balance', ascending: true }
        };
        
        // Charts
        let payoffChart = null;
        let chartInitialized = false;
        
        // Initialize
        function init() {
            try {
                loadState();
                
                // Initialize charts after a delay to ensure Chart.js is loaded
                setTimeout(() => {
                    initCharts();
                    updateAllCalculations();
                }, 100);
                
                // Set default split values
                document.getElementById('defaultTithe').value = state.defaultSplits.tithe;
                document.getElementById('defaultTax').value = state.defaultSplits.tax;
                document.getElementById('defaultDebt').value = state.defaultSplits.debt;
                document.getElementById('defaultFlexible').value = state.defaultSplits.flexible;
                
                // Set threshold values
                document.getElementById('debtThresholdGood').value = state.thresholds.debtGood;
                document.getElementById('debtThresholdWarning').value = state.thresholds.debtWarning;
                document.getElementById('interestThresholdWarning').value = state.thresholds.interestWarning;
                document.getElementById('interestThresholdBad').value = state.thresholds.interestBad;
                
                // Set up checkbox listener
                document.getElementById('useDefaultSplit').addEventListener('change', function() {
                    document.getElementById('customSplitEditor').style.display = 
                        this.checked ? 'none' : 'block';
                });
                
                // Set up custom split listeners
                ['customTithe', 'customTax', 'customDebt'].forEach(id => {
                    document.getElementById(id).addEventListener('input', updateCustomFlexible);
                });
                
                // Set up edit modal split listeners
                ['editTithe', 'editTax', 'editDebt'].forEach(id => {
                    document.getElementById(id).addEventListener('input', updateEditFlexible);
                });
                
                // Set today's date for payment forms
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('debtPaymentDate').value = today;
                document.getElementById('taxPaymentDate').value = today;
                
                // Populate debt selects
                updateDebtSelects();
                
                console.log('Financial Command Center initialized successfully');
                
                // Update last saved time if available
                const lastSaved = localStorage.getItem('financialStateLastSaved');
                if (lastSaved) {
                    const lastSavedEl = document.getElementById('lastSaved');
                    if (lastSavedEl) {
                        lastSavedEl.textContent = lastSaved;
                    }
                }
                
            } catch (error) {
                console.error('Error during initialization:', error);
                alert('There was an error loading your financial data. The app will continue with default settings.');
                
                // Try to continue with defaults
                try {
                    resetToDefaults();
                    updateAllCalculations();
                } catch (secondaryError) {
                    console.error('Critical error - unable to initialize:', secondaryError);
                    alert('Critical error loading the application. Please refresh the page.');
                }
            }
        }
        
        // Tab Management
        function switchTab(tabName, event) {
            // Update tab buttons
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // If called from quickPayTax, find the correct tab
            if (!event) {
                const tabs = document.querySelectorAll('.tab');
                tabs.forEach(tab => {
                    if (tab.textContent.toLowerCase().includes(tabName.toLowerCase()) ||
                        (tabName === 'payments' && tab.textContent.includes('Manual Payments')) ||
                        (tabName === 'taxes' && tab.textContent.includes('Quarterly Taxes'))) {
                        tab.classList.add('active');
                    }
                });
            } else {
                event.target.classList.add('active');
            }
            
            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(`${tabName}-tab`).classList.add('active');
            
            // Initialize chart when switching to Debts tab
            if (tabName === 'debts' && !chartInitialized) {
                setTimeout(() => {
                    initCharts();
                }, 100);
            }
        }
        
        // Load/Save State
        function loadState() {
            const saved = localStorage.getItem('financialState');
            if (saved) {
                try {
                    const parsed = JSON.parse(saved);
                    // Merge with defaults to handle new properties
                    Object.assign(state, parsed);
                    
                    // Ensure new properties exist
                    if (!state.thresholds) {
                        state.thresholds = {
                            debtGood: 50000,
                            debtWarning: 75000,
                            interestWarning: 500,
                            interestBad: 800
                        };
                    }
                    if (!state.paymentHistory) {
                        state.paymentHistory = [];
                    }
                    if (!state.debtSort) {
                        state.debtSort = { column: 'balance', ascending: true };
                    }
                    
                    // Clean up income history data to prevent errors
                    cleanupIncomeData();
                    
                    // Recalculate quarterlyPaid based on 1099 income only
                    recalculateQuarterlyTax();
                    
                } catch (error) {
                    console.error('Error loading saved state:', error);
                    // Reset to defaults if data is corrupted
                    resetToDefaults();
                }
            }
        }
        
        // Recalculate quarterly tax from 1099 income entries
        function recalculateQuarterlyTax() {
            state.quarterlyPaid = 0;
            
            // Add up tax amounts from 1099 income only
            state.incomeHistory.forEach(entry => {
                if (entry && (entry.type === 'commission' || entry.type === 'override' || entry.type === 'other-1099') && entry.tax) {
                    state.quarterlyPaid += entry.tax;
                }
            });
            
            // Add manual tax payments
            if (state.paymentHistory) {
                state.paymentHistory.forEach(payment => {
                    if (payment && payment.type === 'tax' && payment.amount) {
                        state.quarterlyPaid += payment.amount;
                    }
                });
            }
            
            console.log('Recalculated quarterly tax paid:', state.quarterlyPaid);
        }
        
        // Clean up any problematic income data
        function cleanupIncomeData() {
            if (!Array.isArray(state.incomeHistory)) {
                state.incomeHistory = [];
                return;
            }
            
            state.incomeHistory = state.incomeHistory.filter(entry => {
                // Remove entries that are completely invalid
                if (!entry || typeof entry !== 'object') {
                    console.warn('Removing invalid income entry:', entry);
                    return false;
                }
                
                // Fix missing or invalid properties
                if (typeof entry.amount !== 'number' || isNaN(entry.amount)) {
                    console.warn('Removing income entry with invalid amount:', entry);
                    return false;
                }
                
                // Ensure required properties exist with defaults
                if (!entry.date) {
                    entry.date = new Date().toISOString();
                }
                
                if (!entry.type || entry.type === 'undefined' || entry.type === 'null') {
                    entry.type = 'other';
                }
                
                if (!entry.splits || typeof entry.splits !== 'object') {
                    entry.splits = { tithe: 10, tax: 22.9, debt: 30, flexible: 37.1 };
                }
                
                // Ensure split amounts exist
                if (typeof entry.tithe !== 'number') entry.tithe = entry.amount * 0.1;
                if (typeof entry.tax !== 'number') entry.tax = entry.amount * 0.229;
                if (typeof entry.debt !== 'number') entry.debt = entry.amount * 0.3;
                if (typeof entry.flexible !== 'number') entry.flexible = entry.amount * 0.371;
                
                if (!entry.id) {
                    entry.id = Date.now() + Math.random();
                }
                
                return true;
            });
            
            console.log(`Cleaned up ${state.incomeHistory.length} income entries`);
        }
        
        function resetToDefaults() {
            console.warn('Resetting to default state due to data corruption');
            Object.assign(state, {
                debts: [
                    { id: 1, name: 'IRS 2022', balance: 10066, rate: 0.07, minPayment: 124.58, originalBalance: 10066 },
                    { id: 2, name: 'IRS 2023', balance: 13153, rate: 0.07, minPayment: 124.58, originalBalance: 13153 },
                    { id: 3, name: 'IRS 2024', balance: 33814, rate: 0.07, minPayment: 124.84, originalBalance: 33814 },
                    { id: 4, name: 'Chase Card', balance: 17968, rate: 0.2924, minPayment: 538, originalBalance: 17968 },
                    { id: 5, name: 'Pinnacle', balance: 22078, rate: 0, minPayment: 0, originalBalance: 22078 }
                ],
                quarterlyTaxGoal: 9566,
                quarterlyPaid: 0,
                strategy: 'snowball',
                defaultSplits: {
                    tithe: 10,
                    tax: 22.9,
                    debt: 30,
                    flexible: 37.1
                },
                thresholds: {
                    debtGood: 50000,
                    debtWarning: 75000,
                    interestWarning: 500,
                    interestBad: 800
                },
                incomeHistory: [],
                paymentHistory: [],
                totalInterestPaid: 0,
                currentEditingIncomeId: null,
                currentEditingPaymentId: null,
                debtSort: { column: 'balance', ascending: true }
            });
        }
        
        function saveState() {
            localStorage.setItem('financialState', JSON.stringify(state));
            // Update last saved timestamp
            const timestamp = new Date().toLocaleString();
            localStorage.setItem('financialStateLastSaved', timestamp);
            const lastSavedEl = document.getElementById('lastSaved');
            if (lastSavedEl) {
                lastSavedEl.textContent = timestamp;
            }
        }
        
        // Format Currency
        function formatCurrency(amount, showSign = false) {
            const formatted = new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(Math.abs(amount));
            
            if (showSign && amount < 0) {
                return '-' + formatted;
            }
            return formatted;
        }
        
        // Income Recording
        function recordIncome(event) {
            event.preventDefault();
            
            const income = parseFloat(document.getElementById('overrideIncome').value);
            const type = document.getElementById('incomeType').value || 'other'; // Default to 'other' if no type selected
            const notes = document.getElementById('incomeNotes').value;
            const useDefault = document.getElementById('useDefaultSplit').checked;
            
            if (!income || income <= 0) return;
            
            // Get splits
            let splits;
            if (useDefault) {
                splits = { ...state.defaultSplits };
            } else {
                splits = {
                    tithe: parseFloat(document.getElementById('customTithe').value),
                    tax: parseFloat(document.getElementById('customTax').value),
                    debt: parseFloat(document.getElementById('customDebt').value),
                    flexible: parseFloat(document.getElementById('customFlexible').value)
                };
            }
            
            // Calculate amounts
            const tithe = income * (splits.tithe / 100);
            const tax = income * (splits.tax / 100);
            const debt = income * (splits.debt / 100);
            const flexible = income * (splits.flexible / 100);
            
            // Track quarterly tax - only for 1099 income types
            if (type === 'commission' || type === 'override' || type === 'other-1099') {
                state.quarterlyPaid += tax;
            }
            
            // Record income history
            const entry = {
                id: Date.now(),
                date: new Date().toISOString(),
                amount: income,
                tithe,
                tax,
                debt,
                flexible,
                type,
                notes,
                splits
            };
            
            state.incomeHistory.unshift(entry); // Add to beginning
            
            // Apply debt payment
            applyDebtPayment(debt);
            
            // Clear form
            document.getElementById('overrideIncome').value = '';
            document.getElementById('incomeNotes').value = '';
            document.getElementById('useDefaultSplit').checked = true;
            document.getElementById('customSplitEditor').style.display = 'none';
            
            // Show success animation
            showSuccessAnimation();
            
            saveState();
            updateAllCalculations();
        }
        
        // Income Editing
        function editIncome(id) {
            const entry = state.incomeHistory.find(e => e.id === id);
            if (!entry) return;
            
            state.currentEditingIncomeId = id;
            
            // Populate edit form
            document.getElementById('editIncomeAmount').value = entry.amount;
            document.getElementById('editIncomeType').value = entry.type || 'other'; // Default to 'other' if undefined
            document.getElementById('editIncomeNotes').value = entry.notes || '';
            document.getElementById('editTithe').value = entry.splits.tithe;
            document.getElementById('editTax').value = entry.splits.tax;
            document.getElementById('editDebt').value = entry.splits.debt;
            document.getElementById('editFlexible').value = entry.splits.flexible;
            
            document.getElementById('editIncomeModal').style.display = 'block';
        }
        
        function saveIncomeEdit(event) {
            event.preventDefault();
            
            const id = state.currentEditingIncomeId;
            const entry = state.incomeHistory.find(e => e.id === id);
            if (!entry) return;
            
            // Get old values to reverse tax tracking
            const oldTax = entry.tax;
            const oldType = entry.type;
            
            // Get new values
            const newAmount = parseFloat(document.getElementById('editIncomeAmount').value);
            const newType = document.getElementById('editIncomeType').value || 'other'; // Default to 'other' if undefined
            const newNotes = document.getElementById('editIncomeNotes').value;
            
            const newSplits = {
                tithe: parseFloat(document.getElementById('editTithe').value),
                tax: parseFloat(document.getElementById('editTax').value),
                debt: parseFloat(document.getElementById('editDebt').value),
                flexible: parseFloat(document.getElementById('editFlexible').value)
            };
            
            // Calculate new amounts
            const newTithe = newAmount * (newSplits.tithe / 100);
            const newTax = newAmount * (newSplits.tax / 100);
            const newDebt = newAmount * (newSplits.debt / 100);
            const newFlexible = newAmount * (newSplits.flexible / 100);
            
            // Update tax tracking - only for 1099 income types
            if (oldType === 'commission' || oldType === 'override' || oldType === 'other-1099') {
                state.quarterlyPaid -= oldTax;
            }
            if (newType === 'commission' || newType === 'override' || newType === 'other-1099') {
                state.quarterlyPaid += newTax;
            }
            // Ensure quarterlyPaid doesn't go negative
            state.quarterlyPaid = Math.max(0, state.quarterlyPaid);
            
            // Update entry
            entry.amount = newAmount;
            entry.type = newType;
            entry.notes = newNotes;
            entry.tithe = newTithe;
            entry.tax = newTax;
            entry.debt = newDebt;
            entry.flexible = newFlexible;
            entry.splits = newSplits;
            
            closeModal('editIncomeModal');
            saveState();
            updateAllCalculations();
        }
        
        function updateEditFlexible() {
            const tithe = parseFloat(document.getElementById('editTithe').value) || 0;
            const tax = parseFloat(document.getElementById('editTax').value) || 0;
            const debt = parseFloat(document.getElementById('editDebt').value) || 0;
            const flexible = Math.max(0, 100 - tithe - tax - debt);
            
            document.getElementById('editFlexible').value = flexible.toFixed(1);
        }
        
        // Custom Split Management
        function updateCustomFlexible() {
            const tithe = parseFloat(document.getElementById('customTithe').value) || 0;
            const tax = parseFloat(document.getElementById('customTax').value) || 0;
            const debt = parseFloat(document.getElementById('customDebt').value) || 0;
            const flexible = Math.max(0, 100 - tithe - tax - debt);
            
            document.getElementById('customFlexible').value = flexible.toFixed(1);
        }
        
        function updateDefaultSplits() {
            const tithe = parseFloat(document.getElementById('defaultTithe').value) || 0;
            const tax = parseFloat(document.getElementById('defaultTax').value) || 0;
            const debt = parseFloat(document.getElementById('defaultDebt').value) || 0;
            const flexible = Math.max(0, 100 - tithe - tax - debt);
            
            state.defaultSplits = { tithe, tax, debt, flexible };
            document.getElementById('defaultFlexible').value = flexible.toFixed(1);
            
            saveState();
        }
        
        function updateThresholds() {
            state.thresholds = {
                debtGood: parseFloat(document.getElementById('debtThresholdGood').value) || 50000,
                debtWarning: parseFloat(document.getElementById('debtThresholdWarning').value) || 75000,
                interestWarning: parseFloat(document.getElementById('interestThresholdWarning').value) || 500,
                interestBad: parseFloat(document.getElementById('interestThresholdBad').value) || 800
            };
            
            saveState();
            updateHeaderStatus();
        }
        
        // Income Ledger
        function updateIncomeLedger() {
            const tbody = document.getElementById('incomeLedger');
            if (!tbody) {
                console.warn('Income ledger tbody not found');
                return;
            }
            
            tbody.innerHTML = '';
            
            // Safely process each income entry
            state.incomeHistory.forEach(entry => {
                try {
                    // Validate entry has required properties
                    if (!entry || typeof entry.amount !== 'number' || !entry.date) {
                        console.warn('Skipping invalid income entry:', entry);
                        return;
                    }
                    
                    const row = document.createElement('tr');
                    const date = new Date(entry.date);
                    
                    // Safely get splits with defaults
                    const splits = entry.splits || { tithe: 0, tax: 0, debt: 0, flexible: 0 };
                    const safeType = getIncomeTypeLabel(entry.type);
                    const safeNotes = entry.notes || '';
                    
                    row.innerHTML = `
                        <td>${date.toLocaleDateString()}</td>
                        <td class="positive">${formatCurrency(entry.amount)}</td>
                        <td>${formatCurrency(entry.tithe || 0)} (${(splits.tithe || 0).toFixed(1)}%)</td>
                        <td>${formatCurrency(entry.tax || 0)} (${(splits.tax || 0).toFixed(1)}%)</td>
                        <td>${formatCurrency(entry.debt || 0)} (${(splits.debt || 0).toFixed(1)}%)</td>
                        <td>${formatCurrency(entry.flexible || 0)} (${(splits.flexible || 0).toFixed(1)}%)</td>
                        <td>${safeType}</td>
                        <td>${safeNotes === '' ? '-' : safeNotes}</td>
                        <td>
                            <button onclick="editIncome(${entry.id})" class="edit-btn">✏️</button>
                            <button onclick="deleteIncome(${entry.id})" class="delete-btn">🗑️</button>
                        </td>
                    `;
                    tbody.appendChild(row);
                } catch (error) {
                    console.error('Error creating income ledger row:', error, entry);
                }
            });
        }
        
        function deleteIncome(id) {
            if (confirm('Delete this income entry? This will also reverse any debt payments made from this income.')) {
                const entry = state.incomeHistory.find(e => e.id === id);
                if (entry) {
                    // Reverse tax tracking - only for 1099 income types
                    if (entry.type === 'commission' || entry.type === 'override' || entry.type === 'other-1099') {
                        state.quarterlyPaid = Math.max(0, state.quarterlyPaid - entry.tax);
                    }
                    
                    // Note: Reversing debt payments is complex and would need transaction tracking
                    // For now, we'll just remove the entry
                    
                    state.incomeHistory = state.incomeHistory.filter(e => e.id !== id);
                    saveState();
                    updateAllCalculations();
                }
            }
        }
        
        function getIncomeTypeLabel(type) {
            const labels = {
                salary: 'Salary (W-2)',
                commission: 'Commission (1099)',
                override: 'Override (1099)',
                bonus: 'Bonus (W-2)',
                distribution: 'Distribution (K-1)',
                'other-w2': 'Other (W-2)',
                'other-1099': 'Other (1099)',
                other: 'Other'
            };
            
            try {
                // Handle all possible undefined/null/empty cases
                if (type === null || type === undefined || type === '') {
                    return 'Other';
                }
                
                // Convert to string and clean up
                const typeStr = String(type).toLowerCase().trim();
                
                // Handle string versions of undefined/null
                if (typeStr === 'undefined' || typeStr === 'null' || typeStr === '') {
                    return 'Other';
                }
                
                // Return mapped label or default to 'Other'
                return labels[typeStr] || 'Other';
                
            } catch (error) {
                console.warn('Error in getIncomeTypeLabel:', error, 'type:', type);
                return 'Other';
            }
        }
        
        // Manual Payments
        function recordDebtPayment(event) {
            event.preventDefault();
            
            const debtId = parseInt(document.getElementById('debtPaymentSelect').value);
            const amount = parseFloat(document.getElementById('debtPaymentAmount').value);
            const date = document.getElementById('debtPaymentDate').value;
            const notes = document.getElementById('debtPaymentNotes').value;
            
            const debt = state.debts.find(d => d.id === debtId);
            if (!debt || amount <= 0) return;
            
            // Apply payment
            debt.balance = Math.max(0, debt.balance - amount);
            if (debt.balance === 0) {
                state.debts = state.debts.filter(d => d.id !== debtId);
            }
            
            // Record payment history
            state.paymentHistory.unshift({
                id: Date.now(),
                date: date,
                type: 'debt',
                account: debt.name,
                amount: amount,
                notes: notes
            });
            
            // Clear form
            event.target.reset();
            document.getElementById('debtPaymentDate').value = new Date().toISOString().split('T')[0];
            
            saveState();
            updateAllCalculations();
            updateDebtSelects();
        }
        
        function recordTaxPayment(event) {
            event.preventDefault();
            
            const amount = parseFloat(document.getElementById('taxPaymentAmount').value);
            const date = document.getElementById('taxPaymentDate').value;
            const quarter = document.getElementById('taxPaymentQuarter').value;
            const notes = document.getElementById('taxPaymentNotes').value;
            
            if (amount <= 0) return;
            
            // Update tax tracking
            state.quarterlyPaid += amount;
            
            // Record payment history
            state.paymentHistory.unshift({
                id: Date.now(),
                date: date,
                type: 'tax',
                account: quarter,
                amount: amount,
                notes: notes
            });
            
            // Clear form
            event.target.reset();
            document.getElementById('taxPaymentDate').value = new Date().toISOString().split('T')[0];
            
            saveState();
            updateAllCalculations();
        }
        
        function updateDebtSelects() {
            const debtSelect = document.getElementById('debtPaymentSelect');
            const targetDebtSelect = document.getElementById('targetDebt');
            
            // Clear options
            debtSelect.innerHTML = '<option value="">Choose debt account...</option>';
            targetDebtSelect.innerHTML = '<option value="">All Debts (Current Strategy)</option>';
            
            // Add debt options
            state.debts.forEach(debt => {
                const option1 = document.createElement('option');
                option1.value = debt.id;
                option1.textContent = `${debt.name} (${formatCurrency(debt.balance)})`;
                debtSelect.appendChild(option1);
                
                const option2 = document.createElement('option');
                option2.value = debt.id;
                option2.textContent = debt.name;
                targetDebtSelect.appendChild(option2);
            });
        }
        
        function updatePaymentHistory() {
            const tbody = document.getElementById('paymentHistory');
            tbody.innerHTML = '';
            
            state.paymentHistory.forEach(payment => {
                const row = document.createElement('tr');
                const date = new Date(payment.date);
                
                row.innerHTML = `
                    <td>${date.toLocaleDateString()}</td>
                    <td>${payment.type === 'debt' ? '🏦 Debt' : '📊 Tax'}</td>
                    <td>${payment.account}</td>
                    <td class="negative">${formatCurrency(payment.amount)}</td>
                    <td>${payment.notes || '-'}</td>
                    <td>
                        <button onclick="editPayment(${payment.id})" class="edit-btn">✏️</button>
                        <button onclick="deletePayment(${payment.id})" class="delete-btn">🗑️</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
        
        function deletePayment(id) {
            if (confirm('Delete this payment record?')) {
                const payment = state.paymentHistory.find(p => p.id === id);
                if (payment && payment.type === 'tax') {
                    // Reverse tax tracking
                    state.quarterlyPaid = Math.max(0, state.quarterlyPaid - payment.amount);
                }
                
                state.paymentHistory = state.paymentHistory.filter(p => p.id !== id);
                saveState();
                updateAllCalculations();
            }
        }
        
        // Payment Editing
        function editPayment(id) {
            const payment = state.paymentHistory.find(p => p.id === id);
            if (!payment) return;
            
            state.currentEditingPaymentId = id;
            
            // Populate edit form
            document.getElementById('editPaymentAmount').value = payment.amount;
            document.getElementById('editPaymentDate').value = payment.date;
            document.getElementById('editPaymentNotes').value = payment.notes || '';
            
            // Set up account dropdown based on payment type
            const accountSelect = document.getElementById('editPaymentAccount');
            accountSelect.innerHTML = '';
            
            if (payment.type === 'debt') {
                document.getElementById('editPaymentAccountLabel').textContent = 'Debt Account';
                // Add current debt accounts
                state.debts.forEach(debt => {
                    const option = document.createElement('option');
                    option.value = debt.name;
                    option.textContent = debt.name;
                    option.selected = debt.name === payment.account;
                    accountSelect.appendChild(option);
                });
            } else {
                document.getElementById('editPaymentAccountLabel').textContent = 'Quarter';
                // Add quarters
                ['Q1 2025', 'Q2 2025', 'Q3 2025', 'Q4 2025'].forEach(quarter => {
                    const option = document.createElement('option');
                    option.value = quarter;
                    option.textContent = quarter;
                    option.selected = quarter === payment.account;
                    accountSelect.appendChild(option);
                });
            }
            
            document.getElementById('editPaymentModal').style.display = 'block';
        }
        
        function savePaymentEdit(event) {
            event.preventDefault();
            
            const id = state.currentEditingPaymentId;
            const payment = state.paymentHistory.find(p => p.id === id);
            if (!payment) return;
            
            // Get old values
            const oldAmount = payment.amount;
            const oldType = payment.type;
            
            // Get new values
            const newAmount = parseFloat(document.getElementById('editPaymentAmount').value);
            const newDate = document.getElementById('editPaymentDate').value;
            const newAccount = document.getElementById('editPaymentAccount').value;
            const newNotes = document.getElementById('editPaymentNotes').value;
            
            // Update tax tracking if it's a tax payment
            if (oldType === 'tax') {
                state.quarterlyPaid = state.quarterlyPaid - oldAmount + newAmount;
                state.quarterlyPaid = Math.max(0, state.quarterlyPaid);
            }
            
            // Update payment
            payment.amount = newAmount;
            payment.date = newDate;
            payment.account = newAccount;
            payment.notes = newNotes;
            
            closeModal('editPaymentModal');
            saveState();
            updateAllCalculations();
        }
        
        // What-If Calculator
        function calculateWhatIf() {
            const extraPayment = parseFloat(document.getElementById('extraPayment').value) || 0;
            const targetDebtId = document.getElementById('targetDebt').value;
            
            if (extraPayment <= 0) {
                document.getElementById('whatIfResult').style.display = 'none';
                return;
            }
            
            // Calculate current payoff timeline
            const currentTimeline = calculatePayoffTimeline(0, null);
            const whatIfTimeline = calculatePayoffTimeline(extraPayment, targetDebtId || null);
            
            const monthsSaved = currentTimeline.months - whatIfTimeline.months;
            const interestSaved = currentTimeline.totalInterest - whatIfTimeline.totalInterest;
            
            const result = document.getElementById('whatIfResult');
            result.style.display = 'block';
            result.innerHTML = `
                <h4>Results: Adding ${formatCurrency(extraPayment)}/month</h4>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px; margin-top: 12px;">
                    <div style="text-align: center;">
                        <div style="font-size: 1.2rem; font-weight: 600; color: var(--accent-positive);">
                            ${monthsSaved > 0 ? monthsSaved : 0} months
                        </div>
                        <div style="font-size: 0.85rem; color: var(--text-muted);">faster payoff</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 1.2rem; font-weight: 600; color: var(--accent-positive);">
                            ${formatCurrency(interestSaved)}
                        </div>
                        <div style="font-size: 0.85rem; color: var(--text-muted);">interest saved</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 1.2rem; font-weight: 600; color: var(--accent-info);">
                            ${whatIfTimeline.months} months
                        </div>
                        <div style="font-size: 0.85rem; color: var(--text-muted);">new timeline</div>
                    </div>
                </div>
            `;
        }
        
        function calculatePayoffTimeline(extraPayment, targetDebtId) {
            let months = 0;
            let totalInterest = 0;
            let workingDebts = state.debts.map(d => ({...d}));
            const basePayment = getAverageMonthlyDebtPayment();
            
            while (workingDebts.length > 0 && months < 360) {
                months++;
                
                // Add interest
                workingDebts.forEach(debt => {
                    const monthlyInterest = debt.balance * debt.rate / 12;
                    debt.balance += monthlyInterest;
                    totalInterest += monthlyInterest;
                });
                
                // Apply payments
                let availablePayment = basePayment + extraPayment;
                
                // Pay minimums first
                workingDebts.forEach(debt => {
                    const minPay = Math.min(debt.minPayment, debt.balance, availablePayment);
                    debt.balance -= minPay;
                    availablePayment -= minPay;
                });
                
                // Apply extra payment
                if (availablePayment > 0) {
                    let target;
                    if (targetDebtId) {
                        target = workingDebts.find(d => d.id == targetDebtId && d.balance > 0);
                    } else {
                        // Use current strategy
                        const ordered = workingDebts
                            .filter(d => d.balance > 0)
                            .sort((a, b) => {
                                if (state.strategy === 'snowball') return a.balance - b.balance;
                                return b.rate - a.rate;
                            });
                        target = ordered[0];
                    }
                    
                    if (target) {
                        const payment = Math.min(availablePayment, target.balance);
                        target.balance -= payment;
                    }
                }
                
                // Remove paid debts
                workingDebts = workingDebts.filter(d => d.balance > 0);
            }
            
            return { months, totalInterest };
        }
        
        // Debt Payment Logic
        function applyDebtPayment(amount) {
            const orderedDebts = getOrderedDebts();
            let remaining = amount;
            
            // First, pay minimums
            orderedDebts.forEach(debt => {
                if (remaining >= debt.minPayment && debt.balance > 0) {
                    const payment = Math.min(debt.minPayment, debt.balance);
                    remaining -= payment;
                    debt.balance -= payment;
                }
            });
            
            // Then apply extra to target
            if (remaining > 0 && orderedDebts.length > 0) {
                const target = orderedDebts.find(d => d.balance > 0);
                if (target) {
                    const payment = Math.min(remaining, target.balance);
                    target.balance -= payment;
                }
            }
            
            // Remove paid off debts
            state.debts = state.debts.filter(d => d.balance > 0);
        }
        
        function getOrderedDebts() {
            return [...state.debts].sort((a, b) => {
                if (state.strategy === 'snowball') {
                    return a.balance - b.balance;
                } else {
                    return b.rate - a.rate;
                }
            });
        }
        
        // Update Calculations
        function updateAllCalculations() {
            try {
                const updates = [
                    ['Debt Summary', updateDebtSummary],
                    ['Tax Status', updateTaxStatus],
                    ['Income Summary', updateIncomesSummary],
                    ['Debt Table', updateDebtTable],
                    ['Income Ledger', updateIncomeLedger],
                    ['Payment History', updatePaymentHistory],
                    ['Charts', updateCharts],
                    ['Payoff Dates', updatePayoffDates],
                    ['Header Status', updateHeaderStatus],
                    ['Debt Selects', updateDebtSelects],
                    ['Quarterly Taxes', updateQuarterlyTaxes]
                ];
                
                updates.forEach(([name, updateFunction]) => {
                    try {
                        // Skip chart updates if not initialized
                        if (name === 'Charts' && !chartInitialized) {
                            console.log('Skipping chart update - not yet initialized');
                            return;
                        }
                        updateFunction();
                    } catch (error) {
                        console.error(`Error updating ${name}:`, error);
                    }
                });
                
            } catch (error) {
                console.error('Critical error in updateAllCalculations:', error);
            }
        }
        
        function updateHeaderStatus() {
            const totalDebt = state.debts.reduce((sum, d) => sum + d.balance, 0);
            const monthlyInterest = state.debts.reduce((sum, d) => sum + (d.balance * d.rate / 12), 0);
            
            // Update debt status
            const debtPill = document.getElementById('totalDebtPill');
            if (totalDebt <= state.thresholds.debtGood) {
                debtPill.className = 'stat-pill status-good';
            } else if (totalDebt <= state.thresholds.debtWarning) {
                debtPill.className = 'stat-pill status-warning';
            } else {
                debtPill.className = 'stat-pill status-bad';
            }
            
            // Update interest status
            const interestPill = document.getElementById('monthlyInterestPill');
            if (monthlyInterest <= state.thresholds.interestWarning) {
                interestPill.className = 'stat-pill status-good';
            } else if (monthlyInterest <= state.thresholds.interestBad) {
                interestPill.className = 'stat-pill status-warning';
            } else {
                interestPill.className = 'stat-pill status-bad';
            }
            
            // Update payoff status (simple logic based on debt amount)
            const payoffPill = document.getElementById('payoffDatePill');
            if (totalDebt === 0) {
                payoffPill.className = 'stat-pill status-good';
            } else if (totalDebt <= state.thresholds.debtWarning) {
                payoffPill.className = 'stat-pill status-warning';
            } else {
                payoffPill.className = 'stat-pill status-bad';
            }
        }
        
        function updateDebtSummary() {
            const totalDebt = state.debts.reduce((sum, d) => sum + d.balance, 0);
            const debtCount = state.debts.length;
            
            let avgRate = 0;
            if (totalDebt > 0) {
                avgRate = state.debts.reduce((sum, d) => sum + d.rate * d.balance, 0) / totalDebt;
            }
            
            const dailyInterest = state.debts.reduce((sum, d) => sum + (d.balance * d.rate / 365), 0);
            const weeklyInterest = dailyInterest * 7;
            const monthlyInterest = dailyInterest * 30;
            
            // Update UI
            document.getElementById('totalDebt').textContent = formatCurrency(totalDebt, true);
            document.getElementById('totalDebtHeader').textContent = formatCurrency(totalDebt, true);
            document.getElementById('monthlyInterestHeader').textContent = formatCurrency(monthlyInterest, true);
            document.getElementById('debtCount').textContent = debtCount;
            document.getElementById('avgRate').textContent = (avgRate * 100).toFixed(1) + '%';
            
            document.getElementById('dailyInterest').textContent = formatCurrency(dailyInterest);
            document.getElementById('weeklyInterest').textContent = formatCurrency(weeklyInterest);
            document.getElementById('monthlyInterest').textContent = formatCurrency(monthlyInterest);
        }
        
        function updateTaxStatus() {
            const progress = (state.quarterlyPaid / state.quarterlyTaxGoal) * 100;
            const remaining = Math.max(0, state.quarterlyTaxGoal - state.quarterlyPaid);
            
            document.getElementById('taxStatus').textContent = 
                remaining > 0 ? formatCurrency(remaining, true) : '+' + formatCurrency(Math.abs(remaining));
            document.getElementById('taxStatus').className = 
                remaining > 0 ? 'card-value negative' : 'card-value positive';
            
            document.getElementById('taxContributed').textContent = formatCurrency(state.quarterlyPaid);
            document.getElementById('taxGoal').textContent = formatCurrency(state.quarterlyTaxGoal);
            
            const progressBar = document.getElementById('taxProgress');
            progressBar.style.width = Math.min(100, progress) + '%';
            progressBar.className = progress >= 100 ? 'progress-fill' : 'progress-fill danger';
            
            // Update current quarter tax
            updateCurrentQuarterTax();
        }
        
        function updateCurrentQuarterTax() {
            const today = new Date();
            const currentMonth = today.getMonth();
            let currentQuarter, dueDate;
            
            if (currentMonth < 3) {
                currentQuarter = 'Q1 2025';
                dueDate = new Date('2025-04-15');
            } else if (currentMonth < 6) {
                currentQuarter = 'Q2 2025';
                dueDate = new Date('2025-06-16');
            } else if (currentMonth < 9) {
                currentQuarter = 'Q3 2025';
                dueDate = new Date('2025-09-15');
            } else {
                currentQuarter = 'Q4 2025';
                dueDate = new Date('2026-01-15');
            }
            
            // Calculate current quarter tax from 1099 income
            let currentQuarterTax = 0;
            state.incomeHistory.forEach(entry => {
                if (entry && (entry.type === 'commission' || entry.type === 'override' || entry.type === 'other-1099')) {
                    const incomeDate = new Date(entry.date);
                    const incomeMonth = incomeDate.getMonth();
                    
                    // Check if income is in current quarter
                    if ((currentQuarter === 'Q1 2025' && incomeMonth < 3) ||
                        (currentQuarter === 'Q2 2025' && incomeMonth >= 3 && incomeMonth < 6) ||
                        (currentQuarter === 'Q3 2025' && incomeMonth >= 6 && incomeMonth < 9) ||
                        (currentQuarter === 'Q4 2025' && incomeMonth >= 9)) {
                        currentQuarterTax += entry.tax || 0;
                    }
                }
            });
            
            // Subtract payments made for current quarter
            let currentQuarterPaid = 0;
            state.paymentHistory.forEach(payment => {
                if (payment && payment.type === 'tax' && payment.account === currentQuarter) {
                    currentQuarterPaid += payment.amount;
                }
            });
            
            const unpaidTax = Math.max(0, currentQuarterTax - currentQuarterPaid);
            const daysUntilDue = Math.ceil((dueDate - today) / (1000 * 60 * 60 * 24));
            
            // Update UI
            document.getElementById('currentQuarterTax').textContent = formatCurrency(unpaidTax);
            document.getElementById('currentQuarterTax').className = unpaidTax > 0 ? 'card-value warning' : 'card-value positive';
            document.getElementById('currentQuarter').textContent = currentQuarter;
            document.getElementById('currentQuarterDue').textContent = dueDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            
            const statusEl = document.getElementById('currentQuarterStatus');
            if (unpaidTax > 0) {
                if (daysUntilDue < 0) {
                    statusEl.innerHTML = `<span style="color: var(--accent-negative);">⚠️ Overdue by ${Math.abs(daysUntilDue)} days</span>`;
                } else if (daysUntilDue < 30) {
                    statusEl.innerHTML = `<span style="color: var(--accent-warning);">⏰ Due in ${daysUntilDue} days</span>`;
                } else {
                    statusEl.innerHTML = `<span style="color: var(--text-muted);">Due in ${daysUntilDue} days</span>`;
                }
            } else {
                statusEl.innerHTML = `<span style="color: var(--accent-positive);">✓ Paid in full</span>`;
            }
        }
        
        function updateIncomesSummary() {
            const totalIncome = state.incomeHistory.reduce((sum, e) => sum + (e.amount || 0), 0);
            const incomeByType = {};
            
            // Safely process each income entry with robust error handling
            state.incomeHistory.forEach(entry => {
                // Ensure entry exists and has required properties
                if (!entry || typeof entry.amount !== 'number') {
                    console.warn('Invalid income entry found:', entry);
                    return;
                }
                
                // Normalize the type - handle all undefined/null/empty cases
                let entryType = 'other'; // Default fallback
                
                if (entry.hasOwnProperty('type') && entry.type !== null && entry.type !== undefined) {
                    const typeStr = String(entry.type).trim();
                    if (typeStr !== '' && typeStr !== 'undefined' && typeStr !== 'null') {
                        entryType = typeStr;
                    }
                }
                
                // Initialize the type group if it doesn't exist
                if (!incomeByType.hasOwnProperty(entryType)) {
                    incomeByType[entryType] = 0;
                }
                
                // Add the amount to the type group
                incomeByType[entryType] += entry.amount;
            });
            
            // Update total income display
            const totalIncomeElement = document.getElementById('totalIncome');
            const incomeCountElement = document.getElementById('incomeCount');
            
            if (totalIncomeElement) {
                totalIncomeElement.textContent = formatCurrency(totalIncome);
            }
            if (incomeCountElement) {
                incomeCountElement.textContent = state.incomeHistory.length;
            }
            
            // Update type breakdown with error handling
            const summaryDiv = document.getElementById('incomeSummary');
            if (!summaryDiv) {
                console.warn('Income summary div not found');
                return;
            }
            
            summaryDiv.innerHTML = '';
            
            // Only process if we have income data
            if (Object.keys(incomeByType).length === 0) {
                summaryDiv.innerHTML = '<div style="color: var(--text-muted); text-align: center; padding: 20px;">No income entries recorded yet</div>';
                return;
            }
            
            // Create cards for each income type
            Object.entries(incomeByType).forEach(([type, amount]) => {
                try {
                    const card = document.createElement('div');
                    card.className = 'income-type-card';
                    
                    // Safely get the label and format the amount
                    const safeLabel = getIncomeTypeLabel(type);
                    const safeAmount = formatCurrency(amount || 0);
                    
                    card.innerHTML = `
                        <div class="income-type-label">${safeLabel}</div>
                        <div class="income-type-amount">${safeAmount}</div>
                    `;
                    summaryDiv.appendChild(card);
                } catch (error) {
                    console.error('Error creating income type card:', error, { type, amount });
                }
            });
        }
        
        function updateDebtTable() {
            const tbody = document.getElementById('debtTableBody');
            tbody.innerHTML = '';
            
            // Get sorted debts
            let sortedDebts = [...state.debts];
            
            // Add calculated fields for sorting
            sortedDebts = sortedDebts.map(debt => ({
                ...debt,
                monthlyInterest: debt.balance * debt.rate / 12
            }));
            
            // Apply sorting
            sortedDebts.sort((a, b) => {
                let aVal = a[state.debtSort.column];
                let bVal = b[state.debtSort.column];
                
                if (state.debtSort.column === 'name') {
                    aVal = aVal.toLowerCase();
                    bVal = bVal.toLowerCase();
                }
                
                if (state.debtSort.ascending) {
                    return aVal < bVal ? -1 : aVal > bVal ? 1 : 0;
                } else {
                    return aVal > bVal ? -1 : aVal < bVal ? 1 : 0;
                }
            });
            
            // Update sort indicators
            ['name', 'balance', 'rate', 'minPayment', 'monthlyInterest'].forEach(col => {
                const indicator = document.getElementById(`sort-${col}`);
                if (indicator) {
                    if (state.debtSort.column === col) {
                        indicator.textContent = state.debtSort.ascending ? '↑' : '↓';
                        indicator.style.opacity = '1';
                    } else {
                        indicator.textContent = '↕';
                        indicator.style.opacity = '0.5';
                    }
                }
            });
            
            // Get ordered debts for targeting
            const orderedDebts = getOrderedDebts();
            const targetDebtId = orderedDebts.length > 0 ? orderedDebts[0].id : null;
            
            sortedDebts.forEach((debt) => {
                const monthlyInterest = debt.monthlyInterest;
                const payoffDate = calculatePayoffDate(debt, debt.id === targetDebtId);
                
                const row = document.createElement('tr');
                if (debt.id === targetDebtId) row.style.backgroundColor = 'rgba(59, 130, 246, 0.1)';
                
                row.innerHTML = `
                    <td>${debt.name} ${debt.id === targetDebtId ? '🎯' : ''}</td>
                    <td class="negative">${formatCurrency(debt.balance, true)}</td>
                    <td class="warning">${(debt.rate * 100).toFixed(2)}%</td>
                    <td>${formatCurrency(debt.minPayment)}</td>
                    <td class="negative">${formatCurrency(monthlyInterest, true)}</td>
                    <td>${payoffDate}</td>
                    <td>
                        <button onclick="removeDebt(${debt.id})" class="secondary" style="padding: 4px 12px; font-size: 0.9rem;">Remove</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
        
        // Sort debts function
        function sortDebts(column) {
            if (state.debtSort.column === column) {
                state.debtSort.ascending = !state.debtSort.ascending;
            } else {
                state.debtSort.column = column;
                state.debtSort.ascending = true;
            }
            
            updateDebtTable();
        }
        
        function calculatePayoffDate(debt, isTarget) {
            if (debt.balance === 0) return 'Paid Off';
            
            // Get average monthly payment for this debt
            let monthlyPayment = debt.minPayment;
            
            if (isTarget && state.incomeHistory.length > 0) {
                // Calculate average extra payment based on income history
                const avgMonthlyIncome = state.incomeHistory.reduce((sum, e) => sum + e.amount, 0) / 
                                       Math.max(1, getMonthsSpan());
                const avgDebtPayment = avgMonthlyIncome * 0.3; // Assume 30% to debt
                const totalMinPayments = state.debts.reduce((sum, d) => sum + d.minPayment, 0);
                const extraPayment = Math.max(0, avgDebtPayment - totalMinPayments);
                monthlyPayment += extraPayment;
            }
            
            // Check if payment covers interest
            const monthlyInterest = debt.balance * debt.rate / 12;
            if (monthlyPayment <= monthlyInterest) {
                return 'Never (payment too low)';
            }
            
            // Calculate months to payoff
            const r = debt.rate / 12;
            let months;
            
            if (r === 0) {
                months = debt.balance / monthlyPayment;
            } else {
                months = -Math.log(1 - (debt.balance * r) / monthlyPayment) / Math.log(1 + r);
            }
            
            if (isNaN(months) || months < 0) {
                return 'Error in calculation';
            }
            
            const payoffDate = new Date();
            payoffDate.setMonth(payoffDate.getMonth() + Math.ceil(months));
            
            return payoffDate.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
        }
        
        function getMonthsSpan() {
            try {
                if (!Array.isArray(state.incomeHistory) || state.incomeHistory.length < 2) {
                    return 1;
                }
                
                // Filter for valid date entries
                const validDates = state.incomeHistory
                    .filter(e => e && e.date)
                    .map(e => {
                        try {
                            return new Date(e.date);
                        } catch (dateError) {
                            console.warn('Invalid date in income entry:', e.date);
                            return null;
                        }
                    })
                    .filter(date => date && !isNaN(date.getTime()));
                
                if (validDates.length < 2) {
                    return 1;
                }
                
                const timestamps = validDates.map(d => d.getTime());
                const oldest = Math.min(...timestamps);
                const newest = Math.max(...timestamps);
                
                const months = (newest - oldest) / (1000 * 60 * 60 * 24 * 30);
                const result = Math.max(1, months);
                
                return isNaN(result) ? 1 : result;
                
            } catch (error) {
                console.error('Error calculating months span:', error);
                return 1;
            }
        }
        
        function updatePayoffDates() {
            // Calculate overall payoff date
            if (state.debts.length === 0) {
                document.getElementById('payoffDateHeader').textContent = 'Debt Free!';
                return;
            }
            
            // Simple projection based on current strategy
            let totalMonths = 0;
            let remainingDebts = state.debts.map(d => ({...d}));
            const avgMonthlyPayment = getAverageMonthlyDebtPayment();
            
            while (remainingDebts.length > 0 && totalMonths < 360) {
                totalMonths++;
                
                // Apply payments
                let availablePayment = avgMonthlyPayment;
                
                // Pay minimums first
                remainingDebts.forEach(debt => {
                    if (debt.balance > 0) {
                        const minPay = Math.min(debt.minPayment, debt.balance);
                        debt.balance -= minPay;
                        availablePayment -= minPay;
                        
                        // Add interest
                        debt.balance += debt.balance * debt.rate / 12;
                    }
                });
                
                // Apply extra to target
                const ordered = remainingDebts
                    .filter(d => d.balance > 0)
                    .sort((a, b) => {
                        if (state.strategy === 'snowball') return a.balance - b.balance;
                        return b.rate - a.rate;
                    });
                
                if (ordered.length > 0 && availablePayment > 0) {
                    ordered[0].balance = Math.max(0, ordered[0].balance - availablePayment);
                }
                
                // Remove paid debts
                remainingDebts = remainingDebts.filter(d => d.balance > 0);
            }
            
            const payoffDate = new Date();
            payoffDate.setMonth(payoffDate.getMonth() + totalMonths);
            document.getElementById('payoffDateHeader').textContent = 
                payoffDate.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
        }
        
        function getAverageMonthlyDebtPayment() {
            try {
                if (!Array.isArray(state.incomeHistory) || state.incomeHistory.length === 0) {
                    // Fallback to minimum payments if no income history
                    if (Array.isArray(state.debts)) {
                        return state.debts.reduce((sum, d) => sum + (d.minPayment || 0), 0);
                    }
                    return 0;
                }
                
                // Calculate total debt payments from valid income entries
                const totalDebtPayments = state.incomeHistory
                    .filter(e => e && typeof e.debt === 'number' && !isNaN(e.debt))
                    .reduce((sum, e) => sum + e.debt, 0);
                
                const months = Math.max(1, getMonthsSpan());
                
                const avgPayment = totalDebtPayments / months;
                
                // Ensure we return a valid number
                return isNaN(avgPayment) ? 0 : avgPayment;
                
            } catch (error) {
                console.error('Error calculating average monthly debt payment:', error);
                // Return minimum payments as fallback
                if (Array.isArray(state.debts)) {
                    return state.debts.reduce((sum, d) => sum + (d.minPayment || 0), 0);
                }
                return 0;
            }
        }
        
        // Charts
        function initCharts() {
            try {
                // Check if Chart.js is loaded
                if (typeof Chart === 'undefined') {
                    console.warn('Chart.js library not loaded, retrying in 500ms...');
                    setTimeout(initCharts, 500);
                    return;
                }
                
                const payoffCanvas = document.getElementById('payoffChart');
                if (!payoffCanvas) {
                    console.warn('Payoff chart canvas not found - this is normal if not on the Debts tab');
                    return;
                }
                
                const payoffCtx = payoffCanvas.getContext('2d');
                if (!payoffCtx) {
                    console.warn('Could not get 2D context for payoff chart');
                    return;
                }
                
                // Destroy existing chart if it exists
                if (payoffChart && typeof payoffChart.destroy === 'function') {
                    try {
                        payoffChart.destroy();
                        payoffChart = null;
                    } catch (destroyError) {
                        console.warn('Error destroying existing chart:', destroyError);
                    }
                }
                
                // Create new chart
                try {
                    payoffChart = new Chart(payoffCtx, {
                        type: 'line',
                        data: {
                            labels: [],
                            datasets: [{
                                label: 'Total Debt',
                                data: [],
                                borderColor: '#3b82f6',
                                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                                tension: 0.4
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { display: false }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: {
                                        callback: function(value) {
                                            try {
                                                return formatCurrency(value);
                                            } catch (error) {
                                                return '$' + value;
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    });
                    
                    chartInitialized = true;
                    console.log('Payoff chart initialized successfully');
                    
                    // Initial update after successful initialization
                    setTimeout(() => {
                        if (chartInitialized && payoffChart) {
                            updateCharts();
                        }
                    }, 100);
                    
                } catch (chartError) {
                    console.error('Error creating chart:', chartError);
                    payoffChart = null;
                    chartInitialized = false;
                }
                
            } catch (error) {
                console.error('Error initializing charts:', error);
                payoffChart = null;
                chartInitialized = false;
            }
        }
        
        function updateCharts() {
            try {
                // Skip if chart is not initialized
                if (!chartInitialized || !payoffChart) {
                    console.log('Chart not yet initialized, skipping update');
                    return;
                }
                
                // Check if chart exists and is properly initialized
                if (!payoffChart.data || !payoffChart.data.datasets || !payoffChart.data.datasets[0]) {
                    console.warn('Payoff chart structure is invalid, reinitializing...');
                    chartInitialized = false;
                    initCharts();
                    return;
                }
                
                // Validate income data before processing
                if (!Array.isArray(state.incomeHistory)) {
                    console.warn('Income history is not an array, skipping chart update');
                    return;
                }
                
                // Log current income data for debugging
                console.log('Current income history for chart update:', {
                    count: state.incomeHistory.length,
                    entries: state.incomeHistory.map(entry => ({
                        id: entry.id,
                        type: entry.type,
                        amount: entry.amount,
                        hasType: entry.hasOwnProperty('type'),
                        typeIsUndefined: entry.type === undefined
                    }))
                });
                
                // Update payoff projection with error handling
                const months = 24;
                const labels = [];
                const data = [];
                
                // Validate debt data
                if (!Array.isArray(state.debts)) {
                    console.warn('Debts array is invalid, using empty array');
                    state.debts = [];
                }
                
                let projectedDebts = state.debts.map(d => ({
                    ...d,
                    balance: d.balance || 0,
                    rate: d.rate || 0,
                    minPayment: d.minPayment || 0
                }));
                
                let totalBalance = projectedDebts.reduce((sum, d) => sum + (d.balance || 0), 0);
                const monthlyPayment = getAverageMonthlyDebtPayment() || 0;
                
                for (let i = 0; i <= months; i++) {
                    try {
                        const date = new Date();
                        date.setMonth(date.getMonth() + i);
                        labels.push(date.toLocaleDateString('en-US', { month: 'short', year: '2-digit' }));
                        data.push(totalBalance);
                        
                        if (i < months && totalBalance > 0 && projectedDebts.length > 0) {
                            // Apply projected payments
                            let payment = monthlyPayment;
                            
                            // Simple allocation with error handling
                            projectedDebts.forEach(debt => {
                                try {
                                    if (debt && debt.balance > 0) {
                                        const interest = (debt.balance || 0) * (debt.rate || 0) / 12;
                                        const allocated = Math.min(payment / Math.max(1, projectedDebts.length), debt.balance + interest);
                                        debt.balance = Math.max(0, debt.balance + interest - allocated);
                                        payment = Math.max(0, payment - allocated);
                                    }
                                } catch (debtError) {
                                    console.warn('Error processing debt in chart calculation:', debtError, debt);
                                }
                            });
                            
                            totalBalance = projectedDebts.reduce((sum, d) => sum + (d.balance || 0), 0);
                        }
                    } catch (monthError) {
                        console.warn('Error calculating month', i, monthError);
                        // Use previous month's data
                        labels.push(`Month ${i}`);
                        data.push(data[data.length - 1] || 0);
                    }
                }
                
                // Safely update chart data
                if (payoffChart && payoffChart.data) {
                    if (payoffChart.data.labels) {
                        payoffChart.data.labels = labels;
                    }
                    
                    if (payoffChart.data.datasets && payoffChart.data.datasets[0] && payoffChart.data.datasets[0].hasOwnProperty('data')) {
                        payoffChart.data.datasets[0].data = data;
                    }
                    
                    // Update chart with error handling
                    if (typeof payoffChart.update === 'function') {
                        payoffChart.update();
                        console.log('Chart updated successfully with', data.length, 'data points');
                    } else {
                        console.warn('Chart update function not available');
                    }
                } else {
                    console.warn('Chart data structure invalid, cannot update');
                }
                
            } catch (error) {
                console.error('Error in updateCharts:', error);
                
                // Only log detailed state if chart was supposed to be initialized
                if (chartInitialized) {
                    console.error('Chart state:', {
                        chartExists: !!payoffChart,
                        chartHasData: !!(payoffChart && payoffChart.data),
                        chartHasDatasets: !!(payoffChart && payoffChart.data && payoffChart.data.datasets),
                        chartHasFirstDataset: !!(payoffChart && payoffChart.data && payoffChart.data.datasets && payoffChart.data.datasets[0])
                    });
                    
                    // Mark chart as not initialized so it can be reinitialized
                    chartInitialized = false;
                }
            }
        }
        
        // Tax Goal Management
        function editTaxGoal() {
            document.getElementById('taxGoalInput').value = state.quarterlyTaxGoal;
            document.getElementById('editTaxModal').style.display = 'block';
        }
        
        function saveTaxGoal(event) {
            event.preventDefault();
            state.quarterlyTaxGoal = parseFloat(document.getElementById('taxGoalInput').value);
            saveState();
            updateTaxStatus();
            closeModal('editTaxModal');
        }
        
        // Debt Management
        function setDebtStrategy(strategy) {
            state.strategy = strategy;
            document.getElementById('snowballBtn').className = strategy === 'snowball' ? '' : 'secondary';
            document.getElementById('avalancheBtn').className = strategy === 'avalanche' ? '' : 'secondary';
            saveState();
            updateAllCalculations();
        }
        
        function showAddDebt() {
            document.getElementById('addDebtModal').style.display = 'block';
        }
        
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }
        
        function addDebt(event) {
            event.preventDefault();
            
            const debt = {
                id: Date.now(),
                name: document.getElementById('debtName').value,
                balance: parseFloat(document.getElementById('debtBalance').value),
                rate: parseFloat(document.getElementById('debtRate').value) / 100,
                minPayment: parseFloat(document.getElementById('debtMinPayment').value),
                originalBalance: parseFloat(document.getElementById('debtBalance').value)
            };
            
            state.debts.push(debt);
            saveState();
            updateAllCalculations();
            closeModal('addDebtModal');
            
            // Reset form
            event.target.reset();
        }
        
        function removeDebt(id) {
            if (confirm('Remove this debt?')) {
                state.debts = state.debts.filter(d => d.id !== id);
                saveState();
                updateAllCalculations();
            }
        }
        
        // Data Management
        function confirmReset() {
            if (confirm('This will delete ALL income history. This cannot be undone. Continue?')) {
                if (confirm('Are you absolutely sure? All income entries will be permanently deleted.')) {
                    state.incomeHistory = [];
                    state.quarterlyPaid = 0;
                    saveState();
                    updateAllCalculations();
                    alert('Income history has been reset.');
                }
            }
        }
        
        function exportData() {
            const dataStr = JSON.stringify(state, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const link = document.createElement('a');
            link.setAttribute('href', dataUri);
            link.setAttribute('download', `financial_data_${new Date().toISOString().split('T')[0]}.json`);
            link.click();
        }
        
        function exportIncomeData() {
            try {
                const headers = ['Date', 'Amount', 'Type', 'Tithe', 'Tax', 'Debt', 'Flexible', 'Notes'];
                const rows = state.incomeHistory
                    .filter(entry => entry && typeof entry.amount === 'number') // Only export valid entries
                    .map(entry => [
                        new Date(entry.date || new Date()).toLocaleDateString(),
                        entry.amount || 0,
                        getIncomeTypeLabel(entry.type),
                        entry.tithe || 0,
                        entry.tax || 0,
                        entry.debt || 0,
                        entry.flexible || 0,
                        entry.notes || ''
                    ]);
                
                const csvContent = [headers, ...rows]
                    .map(row => row.map(field => `"${String(field).replace(/"/g, '""')}"`).join(','))
                    .join('\n');
                
                const blob = new Blob([csvContent], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.setAttribute('href', url);
                link.setAttribute('download', `income_history_${new Date().toISOString().split('T')[0]}.csv`);
                link.click();
                
                // Clean up the URL object
                setTimeout(() => window.URL.revokeObjectURL(url), 100);
                
            } catch (error) {
                console.error('Error exporting income data:', error);
                alert('Error exporting data. Please check the console for details.');
            }
        }
        
        function importData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            
            input.onchange = e => {
                const file = e.target.files[0];
                const reader = new FileReader();
                
                reader.onload = event => {
                    try {
                        const imported = JSON.parse(event.target.result);
                        Object.assign(state, imported);
                        saveState();
                        updateAllCalculations();
                        alert('Data imported successfully!');
                    } catch (error) {
                        alert('Error importing data. Please check the file format.');
                    }
                };
                
                reader.readAsText(file);
            };
            
            input.click();
        }
        
        // Success Animation
        function showSuccessAnimation() {
            const cards = document.querySelectorAll('.card');
            cards.forEach(card => {
                card.classList.add('milestone-reached');
                setTimeout(() => card.classList.remove('milestone-reached'), 500);
            });
        }
        
        // Quarterly Taxes Update
        function updateQuarterlyTaxes() {
            // Define quarters with their due dates
            const quarters = [
                { name: 'Q1 2025', dueDate: new Date('2025-04-15'), months: ['Jan', 'Feb', 'Mar'] },
                { name: 'Q2 2025', dueDate: new Date('2025-06-16'), months: ['Apr', 'May', 'Jun'] },
                { name: 'Q3 2025', dueDate: new Date('2025-09-15'), months: ['Jul', 'Aug', 'Sep'] },
                { name: 'Q4 2025', dueDate: new Date('2026-01-15'), months: ['Oct', 'Nov', 'Dec'] }
            ];
            
            const today = new Date();
            const quarterlyBreakdown = document.getElementById('quarterlyBreakdown');
            
            if (!quarterlyBreakdown) return;
            
            quarterlyBreakdown.innerHTML = '';
            
            // Calculate 1099 income by quarter
            const incomeByQuarter = {};
            const taxByQuarter = {};
            const paymentsByQuarter = {};
            
            // Initialize quarters
            quarters.forEach(q => {
                incomeByQuarter[q.name] = 0;
                taxByQuarter[q.name] = 0;
                paymentsByQuarter[q.name] = 0;
            });
            
            // Process 1099 income
            state.incomeHistory.forEach(entry => {
                if (entry && (entry.type === 'commission' || entry.type === 'override' || entry.type === 'other-1099')) {
                    const date = new Date(entry.date);
                    const month = date.getMonth();
                    let quarter;
                    
                    if (month < 3) quarter = 'Q1 2025';
                    else if (month < 6) quarter = 'Q2 2025';
                    else if (month < 9) quarter = 'Q3 2025';
                    else quarter = 'Q4 2025';
                    
                    incomeByQuarter[quarter] += entry.amount || 0;
                    taxByQuarter[quarter] += entry.tax || 0;
                }
            });
            
            // Process tax payments
            state.paymentHistory.forEach(payment => {
                if (payment && payment.type === 'tax') {
                    paymentsByQuarter[payment.account] = (paymentsByQuarter[payment.account] || 0) + payment.amount;
                }
            });
            
            // Create quarter cards
            quarters.forEach(quarter => {
                const card = document.createElement('div');
                card.className = 'quarter-card';
                
                const daysUntilDue = Math.ceil((quarter.dueDate - today) / (1000 * 60 * 60 * 24));
                const taxReserved = taxByQuarter[quarter.name];
                const taxPaid = paymentsByQuarter[quarter.name];
                const taxDue = taxReserved - taxPaid;
                
                // Determine status
                let status = '';
                let statusClass = '';
                
                if (taxPaid >= taxReserved) {
                    status = 'Paid';
                    statusClass = 'paid';
                } else if (daysUntilDue < 0) {
                    status = 'Overdue';
                    statusClass = 'overdue';
                    card.classList.add('overdue');
                } else if (daysUntilDue < 30) {
                    status = 'Due Soon';
                    statusClass = 'due';
                    card.classList.add('current');
                } else {
                    status = 'Upcoming';
                    statusClass = '';
                }
                
                card.innerHTML = `
                    <h3>${quarter.name}</h3>
                    <div class="quarter-status ${statusClass}">${status}</div>
                    <div class="quarter-details">
                        <div class="quarter-detail">
                            <span class="quarter-detail-label">1099 Income:</span>
                            <span class="positive">${formatCurrency(incomeByQuarter[quarter.name])}</span>
                        </div>
                        <div class="quarter-detail">
                            <span class="quarter-detail-label">Tax Reserved:</span>
                            <span>${formatCurrency(taxReserved)}</span>
                        </div>
                        <div class="quarter-detail">
                            <span class="quarter-detail-label">Tax Paid:</span>
                            <span class="${taxPaid > 0 ? 'positive' : ''}">${formatCurrency(taxPaid)}</span>
                        </div>
                        <div class="quarter-detail">
                            <span class="quarter-detail-label">Balance Due:</span>
                            <span class="${taxDue > 0 ? 'negative' : 'positive'}">${formatCurrency(Math.abs(taxDue))}</span>
                        </div>
                        <div class="quarter-detail">
                            <span class="quarter-detail-label">Due Date:</span>
                            <span>${quarter.dueDate.toLocaleDateString()}</span>
                        </div>
                    </div>
                    ${taxDue > 0 ? `
                        <button onclick="quickPayTax('${quarter.name}', ${taxDue})" style="width: 100%; margin-top: 12px;">
                            Pay ${formatCurrency(taxDue)}
                        </button>
                    ` : ''}
                `;
                
                quarterlyBreakdown.appendChild(card);
            });
            
            // Update 1099 income breakdown table
            const taxIncomeBreakdown = document.getElementById('taxIncomeBreakdown');
            if (taxIncomeBreakdown) {
                taxIncomeBreakdown.innerHTML = '';
                
                const incomeTypes = {
                    'commission': { label: 'Commission (1099)', total: 0, tax: 0, count: 0 },
                    'override': { label: 'Override (1099)', total: 0, tax: 0, count: 0 },
                    'other-1099': { label: 'Other (1099)', total: 0, tax: 0, count: 0 }
                };
                
                state.incomeHistory.forEach(entry => {
                    if (entry && incomeTypes[entry.type]) {
                        incomeTypes[entry.type].total += entry.amount || 0;
                        incomeTypes[entry.type].tax += entry.tax || 0;
                        incomeTypes[entry.type].count++;
                    }
                });
                
                Object.entries(incomeTypes).forEach(([type, data]) => {
                    if (data.count > 0) {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${data.label}</td>
                            <td class="positive">${formatCurrency(data.total)}</td>
                            <td>${formatCurrency(data.tax)}</td>
                            <td>${data.count}</td>
                        `;
                        taxIncomeBreakdown.appendChild(row);
                    }
                });
                
                // Add total row
                const totalRow = document.createElement('tr');
                totalRow.style.fontWeight = '600';
                totalRow.style.borderTop = '2px solid var(--border)';
                const totals = Object.values(incomeTypes).reduce((acc, type) => ({
                    total: acc.total + type.total,
                    tax: acc.tax + type.tax,
                    count: acc.count + type.count
                }), { total: 0, tax: 0, count: 0 });
                
                totalRow.innerHTML = `
                    <td>Total 1099 Income</td>
                    <td class="positive">${formatCurrency(totals.total)}</td>
                    <td>${formatCurrency(totals.tax)}</td>
                    <td>${totals.count}</td>
                `;
                taxIncomeBreakdown.appendChild(totalRow);
            }
            
            // Update tax payment history
            const taxPaymentHistory = document.getElementById('taxPaymentHistory');
            if (taxPaymentHistory) {
                taxPaymentHistory.innerHTML = '';
                
                const taxPayments = state.paymentHistory.filter(p => p.type === 'tax');
                taxPayments.forEach(payment => {
                    const row = document.createElement('tr');
                    const date = new Date(payment.date);
                    
                    row.innerHTML = `
                        <td>${date.toLocaleDateString()}</td>
                        <td>${payment.account}</td>
                        <td class="positive">${formatCurrency(payment.amount)}</td>
                        <td>${payment.notes || '-'}</td>
                        <td>
                            <button onclick="editPayment(${payment.id})" class="edit-btn">✏️</button>
                            <button onclick="deletePayment(${payment.id})" class="delete-btn">🗑️</button>
                        </td>
                    `;
                    taxPaymentHistory.appendChild(row);
                });
            }
        }
        
        // Quick pay tax function
        function quickPayTax(quarter, amount) {
            document.getElementById('taxPaymentAmount').value = amount.toFixed(2);
            document.getElementById('taxPaymentQuarter').value = quarter;
            document.getElementById('taxPaymentNotes').value = `Quarterly estimated tax payment`;
            
            // Switch to manual payments tab
            switchTab('payments');
            
            // Scroll to tax payment form
            const taxCard = document.querySelector('.payment-card:last-child');
            if (taxCard) {
                taxCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
                taxCard.style.animation = 'pulse 0.5s ease 2';
            }
        }
        window.onload = function() {
            // Wait for Chart.js to load
            let chartLoadAttempts = 0;
            const maxAttempts = 10;
            
            function checkAndInit() {
                chartLoadAttempts++;
                
                if (typeof Chart !== 'undefined') {
                    console.log('Chart.js loaded, initializing app...');
                    init();
                } else if (chartLoadAttempts < maxAttempts) {
                    console.log(`Waiting for Chart.js to load... (attempt ${chartLoadAttempts}/${maxAttempts})`);
                    setTimeout(checkAndInit, 200);
                } else {
                    console.warn('Chart.js failed to load after multiple attempts. Initializing without charts...');
                    init();
                }
            }
            
            checkAndInit();
        };
        
        // Debug function to test chart with problematic data
        window.testChartWithProblematicData = function() {
            console.log('Testing chart with problematic income data...');
            
            // Add some test entries with problematic data
            const testEntries = [
                {
                    id: Date.now() + 1,
                    date: new Date().toISOString(),
                    amount: 1000,
                    type: undefined, // This should not break charts
                    tithe: 100,
                    tax: 229,
                    debt: 300,
                    flexible: 371,
                    splits: { tithe: 10, tax: 22.9, debt: 30, flexible: 37.1 }
                },
                {
                    id: Date.now() + 2,
                    date: new Date().toISOString(),
                    amount: 2000,
                    type: null, // This should not break charts
                    tithe: 200,
                    tax: 458,
                    debt: 600,
                    flexible: 742,
                    splits: { tithe: 10, tax: 22.9, debt: 30, flexible: 37.1 }
                },
                {
                    id: Date.now() + 3,
                    date: new Date().toISOString(),
                    amount: 1500,
                    // Missing type property entirely
                    tithe: 150,
                    tax: 343.5,
                    debt: 450,
                    flexible: 556.5,
                    splits: { tithe: 10, tax: 22.9, debt: 30, flexible: 37.1 }
                }
            ];
            
            // Add test entries to state
            testEntries.forEach(entry => state.incomeHistory.unshift(entry));
            
            console.log('Added test entries with problematic types:', testEntries);
            
            // Try to update everything
            try {
                updateAllCalculations();
                console.log('✅ All calculations updated successfully with problematic data');
            } catch (error) {
                console.error('❌ Error updating with problematic data:', error);
            }
            
            // Clean up test data
            setTimeout(() => {
                state.incomeHistory = state.incomeHistory.filter(e => 
                    !testEntries.some(te => te.id === e.id)
                );
                updateAllCalculations();
                console.log('Test data cleaned up');
            }, 5000);
        };
        
        // Close modals on outside click
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        }
    </script>
</body>
</html>
